<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NOVA 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 925: '#0f172a' } },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 2s linear infinite' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ""; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #9880ff; } 50%, 100% { background-color: rgba(152, 128, 255, 0.2); } }
        /* Enhanced content styling for Docs content */
        .msg-content a, #doc-content-area a { color: #60a5fa; text-decoration: underline; word-break: break-all; cursor: pointer; }
        .msg-content img, #doc-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); }
        .msg-content p, #doc-content-area div { margin-bottom: 0.5em; line-height: 1.6; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .msg-group:hover .msg-actions { opacity: 1; }
        .msg-actions { opacity: 0; transition: opacity 0.2s; }
        /* Recording Pulse */
        @keyframes recordPulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .recording-dot { animation: recordPulse 1.5s infinite; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans overflow-hidden selection:bg-blue-500/30">

    <div class="flex h-[100dvh] w-full">
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 border-r border-slate-800 p-6 flex-shrink-0">
            <div class="flex items-center space-x-3 mb-10 px-2">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="ph-bold ph-infinity text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">NOVA 12</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Ultimate Edition</p>
                </div>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all"><i class="ph ph-chats-circle text-xl"></i><span class="font-medium">åŠ©ç†å°è©±</span></button>
                <button onclick="switchTab('schedule')" id="nav-schedule" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-calendar-check text-xl"></i><span class="font-medium">è¡Œç¨‹ç®¡ç†</span></button>
                <button onclick="switchTab('notes')" id="nav-notes" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-notebook text-xl"></i><span class="font-medium">ç­†è¨˜/æ–‡ä»¶</span></button>
            </nav>
            <div class="mt-auto space-y-3">
                <button onclick="openSettings()" class="flex items-center space-x-2 text-xs text-slate-500 hover:text-slate-300 w-full px-2"><i class="ph ph-gear"></i><span>è¨­å®š & API</span></button>
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-center space-x-2"><i id="status-icon" class="ph-fill ph-globe text-blue-400 text-lg"></i><span id="status-name" class="font-bold text-sm">Gemini</span></div>
                    <p id="model-version-display" class="text-[10px] text-slate-500 mt-1">Ready</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-950 overflow-hidden min-h-0">
            <!-- Mobile Header -->
            <div class="md:hidden flex items-center justify-between p-3 bg-slate-900 border-b border-slate-800 z-30 shrink-0">
                <div class="flex items-center space-x-2"><i class="ph-bold ph-infinity text-blue-500 text-xl"></i><span class="font-bold text-white">Nova 12</span></div>
                <div class="flex items-center space-x-2 bg-slate-800/50 px-2 py-1 rounded-lg border border-slate-700/50 cursor-pointer active:scale-95 transition-transform" onclick="cycleManualLocation()">
                    <i id="mobile-weather-icon" class="ph-fill ph-navigation-arrow text-blue-400"></i><span id="mobile-weather-temp" class="text-xs font-bold text-white">æ›´æ–°</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="openSettings()"><i class="ph ph-gear text-slate-400 text-xl"></i></button>
                    <button onclick="toggleMobileMenu()"><i class="ph ph-list text-white text-2xl"></i></button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-slate-950/95 pt-20 px-6 backdrop-blur-md">
                <nav class="space-y-4">
                    <button onclick="switchTab('dashboard'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl bg-slate-800 text-white"><i class="ph ph-chats-circle text-xl"></i><span>åŠ©ç†å°è©±</span></button>
                    <button onclick="switchTab('schedule'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-calendar-check text-xl"></i><span>è¡Œç¨‹ç®¡ç†</span></button>
                    <button onclick="switchTab('notes'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-notebook text-xl"></i><span>ç­†è¨˜/æ–‡ä»¶</span></button>
                </nav>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center mb-6 shrink-0"><h3 class="text-xl font-bold text-white">è¨­å®š</h3><button onclick="closeSettings()"><i class="ph ph-x text-2xl text-slate-400"></i></button></div>
                    <div class="space-y-4 overflow-y-auto flex-1 pr-2">
                        
                        <!-- Docs Monitor Section -->
                        <div class="bg-gradient-to-r from-blue-900/30 to-indigo-900/30 p-4 rounded-xl border border-blue-500/50 shadow-inner space-y-4">
                            <div>
                                <label class="block text-xs text-blue-300 mb-2 font-bold flex items-center gap-2"><i class="ph-fill ph-robot"></i> ç³»çµ±ä»£ç† Google Doc (æœå°‹/çˆ¬èŸ²)</label>
                                <input type="text" id="key-doc-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs focus:border-blue-500 outline-none mb-2" placeholder="Apps Script URL (for Agent)">
                            </div>
                            
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <label class="block text-xs text-emerald-300 mb-1 font-bold"><i class="ph-fill ph-notebook"></i> éš¨æ‰‹è¨˜äº‹æœ¬ A URL</label>
                                    <input type="text" id="key-note-doc-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-emerald-500 outline-none" placeholder="Apps Script URL (Notebook A)">
                                </div>
                                <div>
                                    <label class="block text-xs text-teal-300 mb-1 font-bold"><i class="ph-fill ph-notebook"></i> éš¨æ‰‹è¨˜äº‹æœ¬ B URL</label>
                                    <input type="text" id="key-note-doc-url-2" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-teal-500 outline-none" placeholder="Apps Script URL (Notebook B)">
                                </div>
                            </div>

                            <div class="border-t border-white/10 pt-2">
                                 <label class="block text-xs text-red-300 mb-1 font-bold"><i class="ph-fill ph-upload"></i> Google Drive ä¸Šå‚³ URL (éŒ„éŸ³ç”¨)</label>
                                 <input type="text" id="key-drive-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-red-500 outline-none" placeholder="Apps Script URL (Drive Upload)">
                                 
                                 <!-- SCRIPT HELPER -->
                                 <details class="mt-2 p-2 bg-slate-950/50 rounded border border-slate-700/50">
                                    <summary class="text-[10px] text-blue-400 cursor-pointer font-bold select-none hover:text-blue-300"><i class="ph-bold ph-code"></i> å¦‚ä½•å»ºç«‹ Google Drive ä¸Šå‚³è…³æœ¬ï¼Ÿ(é»æ“Šå±•é–‹)</summary>
                                    <div class="mt-2 text-[10px] text-slate-400 leading-relaxed">
                                        <p class="mb-1">1. å»ºç«‹æ–°çš„ Google Apps Script å°ˆæ¡ˆã€‚</p>
                                        <p class="mb-1">2. è²¼ä¸Šä»¥ä¸‹ç¨‹å¼ç¢¼ (è¦†è“‹åŸæœ¬å…§å®¹)ï¼š</p>
                                        <pre class="bg-slate-900 p-2 rounded border border-slate-700 text-green-400 font-mono select-all overflow-x-auto whitespace-pre-wrap break-all">
function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var filename = data.filename;
    var mimeType = data.mimeType;
    var base64 = data.data;
    var blob = Utilities.newBlob(Utilities.base64Decode(base64), mimeType, filename);
    var file = DriveApp.createFile(blob);
    return ContentService.createTextOutput(JSON.stringify({status: "success", fileId: file.getId(), url: file.getUrl()})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}
                                        </pre>
                                        <p class="mt-2 mb-1">3. é»æ“Šã€Œéƒ¨ç½²ã€>ã€Œæ–°å¢éƒ¨ç½²ã€ã€‚</p>
                                        <p class="mb-1">4. é¡å‹é¸ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ï¼ŒåŸ·è¡Œèº«åˆ†ã€Œæˆ‘ã€ï¼Œ<strong class="text-red-400">èª°å¯ä»¥å­˜å–é¸ã€Œä»»ä½•äººã€</strong>ã€‚</p>
                                        <p>5. è¤‡è£½ç”¢ç”Ÿçš„ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ï¼Œè²¼å…¥ä¸Šæ–¹æ¬„ä½ã€‚</p>
                                    </div>
                                 </details>
                            </div>

                            <div class="flex items-center justify-between">
                                <span id="doc-monitor-status" class="text-[10px] text-slate-500">æœªè¨­å®š</span>
                                <button onclick="testDocConnection()" class="text-[10px] bg-blue-600 px-3 py-1 rounded text-white hover:bg-blue-500">æ¸¬è©¦é€£ç·š</button>
                            </div>
                        </div>
                        <div class="space-y-3 pt-2 pb-4 border-b border-slate-800">
                            <div><label class="block text-xs text-blue-400 mb-1">Gemini API Key</label><input type="password" id="key-gemini" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-green-400 mb-1">SerpApi Key</label><input type="password" id="key-serpapi" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-green-500 outline-none" placeholder="Your SerpApi Key"></div>
                            <div><label class="block text-xs text-rose-400 mb-1">Groq API Key</label><input type="password" id="key-groq" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-rose-500 outline-none"></div>
                            <div><label class="block text-xs text-violet-400 mb-1">Cohere API Key</label><input type="password" id="key-cohere" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-violet-500 outline-none"></div>
                            <div><label class="block text-xs text-emerald-400 mb-1">OpenAI API Key</label><input type="password" id="key-openai" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-emerald-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-300 mb-1">Grok API Key</label><input type="password" id="key-grok" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-slate-500 outline-none"></div>
                        </div>
                    </div>
                    <!-- Export / Import / Save controls in Footer -->
                    <div class="mt-4 pt-2 flex justify-between items-center shrink-0">
                        <div class="flex space-x-2">
                            <button onclick="exportSettings()" class="flex items-center gap-1 text-xs text-blue-400 bg-blue-900/30 border border-blue-500/30 px-3 py-2 rounded-lg hover:bg-blue-800/50 transition-colors"><i class="ph-bold ph-download-simple"></i> åŒ¯å‡ºè¨­å®š</button>
                            <button onclick="triggerImportSettings()" class="flex items-center gap-1 text-xs text-emerald-400 bg-emerald-900/30 border border-emerald-500/30 px-3 py-2 rounded-lg hover:bg-emerald-800/50 transition-colors"><i class="ph-bold ph-upload-simple"></i> åŒ¯å…¥è¨­å®š</button>
                            <input type="file" id="import-settings-input" accept=".json" class="hidden" onchange="importSettings(event)">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="closeSettings()" class="px-4 py-2 text-slate-400 text-sm">å–æ¶ˆ</button>
                            <button onclick="saveKeys()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500">å„²å­˜</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ALARM MODAL -->
            <div id="alarm-modal" class="hidden fixed inset-0 z-[60] bg-slate-950/90 backdrop-blur-md flex flex-col items-center justify-center p-6">
                <div class="bg-slate-900 border border-red-500/50 rounded-2xl p-8 max-w-sm w-full text-center shadow-[0_0_50px_rgba(239,68,68,0.3)] animate-pulse">
                    <i class="ph-fill ph-alarm text-6xl text-red-500 mb-4 inline-block animate-bounce"></i>
                    <h3 class="text-2xl font-bold text-white mb-2">æ™‚é–“åˆ°ï¼</h3>
                    <p id="alarm-text" class="text-lg text-slate-300 mb-8">æé†’äº‹é …å…§å®¹</p>
                    <button onclick="stopAlarm()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform active:scale-95">
                        <i class="ph-bold ph-check-circle mr-2"></i> ç¢º å®š (åœæ­¢)
                    </button>
                </div>
            </div>

            <div id="view-dashboard" class="flex flex-col lg:flex-row h-full w-full relative min-h-0">
                <div class="flex-1 flex flex-col h-full min-w-0 relative">
                    <div class="p-3 border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm flex justify-between items-center shrink-0 overflow-x-auto no-scrollbar">
                         <div class="flex items-center space-x-2 mr-4 shrink-0">
                            <span id="web-search-badge" class="hidden md:flex items-center space-x-1 text-[10px] bg-blue-900/30 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded-full"><i class="ph-bold ph-globe"></i><span>é€£ç¶²æœå°‹</span></span>
                            <!-- Recording Indicator -->
                            <div id="recording-status" class="hidden items-center space-x-2 bg-red-900/50 border border-red-500/50 px-3 py-1 rounded-full animate-pulse mr-2">
                                <div class="w-2 h-2 bg-red-500 rounded-full recording-dot"></div>
                                <span class="text-xs text-red-200 font-bold">éŒ„éŸ³ä¸­...</span>
                            </div>
                            <span id="doc-monitor-badge" class="hidden items-center space-x-1 text-[10px] bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 px-2 py-0.5 rounded-full animate-pulse"><i class="ph-bold ph-arrows-clockwise"></i><span>Docs ç›£æ§ä¸­</span></span>
                            <button onclick="clearChatHistory()" class="text-[10px] text-slate-500 hover:text-red-400 flex items-center space-x-1 border border-slate-700 px-2 py-0.5 rounded-lg transition-colors"><i class="ph-bold ph-trash"></i><span>æ¸…ç©ºå°è©±</span></button>
                         </div>
                         
                         <!-- Update 2: Dropdown Model Selection -->
                         <div class="flex space-x-1 ml-auto shrink-0">
                             <select id="main-model-select" onchange="setModel(this.value)" class="bg-slate-800 border border-slate-600 text-white text-xs rounded-lg px-3 py-1 outline-none focus:border-blue-500 font-bold tracking-wide">
                                 <option value="gemini">Gemini (2.5 Flash)</option>
                                 <option value="grok">Grok (4.1 Fast)</option>
                                 <option value="groq">Groq</option>
                                 <option value="cohere">Cohere</option>
                                 <option value="gpt">OpenAI</option>
                             </select>
                         </div>
                    </div>
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-thin scrollbar-thumb-slate-700"></div>
                    <div class="p-4 bg-slate-900 border-t border-slate-800 shrink-0 z-20 pb-[calc(1rem+env(safe-area-inset-bottom))]">
                        <div id="input-wrapper" class="flex items-center bg-slate-950 rounded-xl px-2 py-2 border border-slate-700 focus-within:border-blue-500 transition-colors">
                            <button id="continuous-btn" onclick="toggleContinuous()" class="p-3 rounded-lg text-slate-500 hover:text-emerald-400 hover:bg-slate-800 transition-all flex-shrink-0 mr-1" title="é€£çºŒèªéŸ³å°è©± (6ç§’è‡ªå‹•ç™¼é€)"><i id="continuous-icon" class="ph-bold ph-infinity text-xl"></i></button>
                            <button id="search-toggle-btn" onclick="toggleSearch()" class="p-3 rounded-lg text-slate-500 hover:text-blue-400 hover:bg-slate-800 transition-all flex-shrink-0 mr-1" title="åˆ‡æ›æœå°‹ (Gemini Only)"><i id="search-icon" class="ph-bold ph-globe text-xl"></i></button>
                            <button id="voice-btn" onclick="toggleVoice()" class="p-3 mr-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all active:scale-95 flex-shrink-0"><i id="voice-icon" class="ph-bold ph-microphone text-xl"></i></button>
                            <input type="text" id="user-input" placeholder="è²¼ä¸Šç¶²å€è‡ªå‹•åˆ†æï¼Œæˆ–è¼¸å…¥ã€Œæœå°‹(å…§å®¹)ã€..." class="flex-1 bg-transparent border-none focus:ring-0 text-white outline-none h-full" onkeydown="handleEnter(event)">
                            <button onclick="handleSendMessage()" id="send-btn" class="ml-2 p-3 rounded-lg text-white bg-blue-600 hover:opacity-90 flex-shrink-0 transition-all"><i id="send-icon" class="ph-bold ph-paper-plane-right"></i></button>
                        </div>
                        <div id="search-hint" class="text-[10px] text-blue-400 mt-2 text-center hidden">ğŸŒ å·²é–‹å•Ÿé€£ç¶²æœå°‹ (Gemini)</div>
                    </div>
                </div>
                
                <!-- Right Sidebar -->
                <div class="hidden lg:flex w-80 bg-slate-900 flex-col p-6 space-y-6 border-l border-slate-800 overflow-y-auto shrink-0">
                    <div class="bg-gradient-to-br from-indigo-900 to-slate-800 rounded-3xl p-6 text-white shadow-lg border border-slate-700 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div><h3 class="text-slate-300 text-xs font-bold uppercase mb-1">ç›®å‰å¤©æ°£</h3><div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="cycleManualLocation()"><i class="ph-fill ph-map-pin text-blue-400"></i><span id="location-name" class="text-lg font-bold text-white border-b border-dashed border-slate-500">æœªå®šä½</span></div></div><i id="weather-icon" class="ph-fill ph-cloud-sun text-4xl text-yellow-400"></i>
                            </div>
                            <div class="mt-4 flex items-end space-x-2"><span id="weather-temp" class="text-5xl font-bold">--Â°</span><span id="weather-desc" class="text-slate-300 text-sm mb-2">--</span></div>
                        </div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-calendar-check text-blue-500"></i>è¿‘æœŸä»»å‹™</h3><button onclick="switchTab('schedule')" class="text-xs text-blue-400">ç®¡ç†</button></div>
                        <div id="mini-todo-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                         <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-500"></i>æœ€æ–°ç­†è¨˜</h3><button onclick="switchTab('notes')" class="text-xs text-blue-400">æŸ¥çœ‹</button></div>
                        <div id="mini-note-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Other Views -->
            <div id="view-schedule" class="hidden flex-col h-full w-full p-6 overflow-y-auto"><div class="max-w-3xl mx-auto w-full"><header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">è¡Œç¨‹ç®¡ç†</h2><button onclick="addTodoManually()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header><div id="full-todo-list" class="space-y-3"></div></div></div>
            
            <!-- Notes View with Write Feature (Updated) -->
            <div id="view-notes" class="hidden flex-col h-full w-full p-6 overflow-y-auto">
                <div class="max-w-5xl mx-auto w-full">
                    
                    <!-- Google Docs Writer Widget -->
                    <div class="bg-gradient-to-r from-blue-900/40 to-slate-900 border border-blue-500/30 rounded-2xl p-6 mb-8 relative overflow-hidden shadow-lg">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-400"></i> éš¨æ‰‹è¨˜äº‹æœ¬</h3>
                                <div class="flex gap-2">
                                    <button onclick="openNoteDocViewer()" class="text-xs bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded-lg border border-slate-600 flex items-center gap-2 transition-colors"><i class="ph-bold ph-book-open"></i> é–±è®€</button>
                                </div>
                            </div>
                            
                            <!-- Notebook Switcher -->
                            <div class="flex space-x-2 mb-4 bg-slate-950/50 p-1 rounded-lg inline-flex">
                                <button onclick="setActiveNotebook(1)" id="btn-nb-1" class="flex-1 text-xs px-4 py-1.5 rounded-md font-bold transition-all bg-emerald-600 text-white">ç­†è¨˜æœ¬ A</button>
                                <button onclick="setActiveNotebook(2)" id="btn-nb-2" class="flex-1 text-xs px-4 py-1.5 rounded-md font-bold transition-all text-slate-400 hover:text-white">ç­†è¨˜æœ¬ B</button>
                            </div>
                            
                            <!-- Tabs -->
                            <div class="flex space-x-2 mb-3">
                                <button onclick="setWriteMode('text')" id="btn-mode-text" class="text-xs px-3 py-1 rounded-full bg-blue-600 text-white font-bold transition-all">ç´”æ–‡å­— / è²¼ä¸Šåœ–ç‰‡ (Ctrl+V)</button>
                                <button onclick="setWriteMode('image')" id="btn-mode-image" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all">åœ–ç‰‡ç¶²å€</button>
                                <button onclick="setWriteMode('link')" id="btn-mode-link" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all">è¶…é€£çµ</button>
                            </div>

                            <div class="flex flex-col gap-3">
                                <!-- Inputs -->
                                <div class="relative">
                                    <textarea id="doc-input-main" rows="5" placeholder="è¼¸å…¥æ–‡å­—å…§å®¹ï¼Œæˆ–ç›´æ¥ Ctrl+V è²¼ä¸Šåœ–ç‰‡..." class="w-full bg-slate-950/80 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none pr-24 resize-none" onkeydown="handleNoteKeydown(event)"></textarea>
                                    <div id="paste-indicator" class="hidden absolute right-3 top-3 text-[10px] text-emerald-400 bg-emerald-900/50 px-2 py-0.5 rounded border border-emerald-500/50 animate-pulse">
                                        <i class="ph-bold ph-image"></i> åœ–ç‰‡å·²å°±ç·’
                                    </div>
                                    <button onclick="clearNoteInput()" class="absolute right-3 bottom-3 text-slate-500 hover:text-red-400 p-1 bg-slate-900/50 rounded-full transition-colors" title="æ¸…é™¤å…§å®¹"><i class="ph-bold ph-trash"></i></button>
                                    
                                    <!-- GALLERY UPLOAD BTN -->
                                    <button onclick="triggerPhotoUpload()" class="absolute right-28 bottom-3 text-slate-500 hover:text-white p-1 bg-slate-900/50 rounded-full transition-colors" title="é¸æ“‡åœ–ç‰‡ (è³‡æ–™å¤¾)"><i class="ph-bold ph-image text-xl"></i></button>
                                    <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhotoSelect(event)">

                                    <!-- CAMERA UPLOAD BTN -->
                                    <button onclick="triggerCameraUpload()" class="absolute right-20 bottom-3 text-slate-500 hover:text-white p-1 bg-slate-900/50 rounded-full transition-colors" title="æ‹ç…§ä¸Šå‚³"><i class="ph-bold ph-camera text-xl"></i></button>
                                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoSelect(event)">

                                    <!-- NOTE VOICE BTN -->
                                    <button onclick="toggleNoteVoice()" id="note-voice-btn" class="absolute right-10 bottom-3 text-slate-500 hover:text-white p-1 bg-slate-900/50 rounded-full transition-colors" title="èªéŸ³è¼¸å…¥"><i id="note-voice-icon" class="ph-bold ph-microphone text-xl"></i></button>
                                </div>
                                <input type="text" id="doc-input-sub" placeholder="è¼¸å…¥é€£çµç¶²å€ (ä¾‹å¦‚: https://...)" class="hidden w-full bg-slate-950/80 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none">
                                
                                <div class="flex justify-end">
                                    <button onclick="handleDocWriteBtn()" id="note-send-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                        <i class="ph-bold ph-paper-plane-right"></i> ç™¼é€å¯«å…¥
                                    </button>
                                </div>
                            </div>
                            <p id="active-notebook-label" class="text-[10px] text-slate-400 mt-2 opacity-80">* ç›®å‰å¯«å…¥ç›®æ¨™ï¼šç­†è¨˜æœ¬ A</p>
                        </div>
                    </div>

                    <header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">æœ¬åœ°ç­†è¨˜ä¸­å¿ƒ</h2><button onclick="addNoteManually()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>æ–°å¢</span></button></header>
                    <div id="full-note-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
            
            <!-- Full Doc Viewer Modal -->
            <div id="doc-viewer-modal" class="hidden fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex flex-col p-4">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="ph-fill ph-book-open text-blue-400"></i> æ–‡ä»¶ç€è¦½å™¨</h3>
                    <div class="flex gap-2">
                        <button onclick="refreshNoteDocView()" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 text-xs"><i class="ph-bold ph-arrows-clockwise"></i> é‡æ–°æ•´ç†</button>
                        <button onclick="closeDocViewer()" class="p-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700"><i class="ph-bold ph-x text-lg"></i></button>
                    </div>
                </div>
                <div class="flex-1 bg-white text-slate-900 rounded-xl p-6 overflow-y-auto shadow-2xl font-serif leading-relaxed text-lg" id="doc-content-area">
                    <div class="flex items-center justify-center h-full text-slate-400 gap-2"><div class="dot-flashing bg-slate-400"></div> è¼‰å…¥ä¸­...</div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global variables
        let recognition = null;
        let noteRecognition = null;
        let voiceTimer = null;
        let initialInput = "";
        
        let alarmInterval = null;
        let alarmAudioCtx = null;
        let mediaRecorder = null;
        let audioChunks = [];

        const appState = {
            currentModel: 'gemini', 
            detectedGeminiModel: null,
            docMonitorUrl: localStorage.getItem('nova_doc_url') || '',
            noteDocUrl: localStorage.getItem('nova_note_doc_url') || '', 
            noteDocUrl2: localStorage.getItem('nova_note_doc_url_2') || '',
            activeNotebook: 1,
            driveUrl: localStorage.getItem('nova_drive_url') || '',
            
            messages: JSON.parse(localStorage.getItem('nova_messages') || '[]'),
            todos: JSON.parse(localStorage.getItem('nova_todos') || '[]'),
            notes: JSON.parse(localStorage.getItem('nova_notes') || '[]'),
            weather: { temp: '--', condition: 'cloudy', humidity: '--', wind: '--', loc: 'æœªå®šä½' },
            keys: { 
                gemini: localStorage.getItem('nova_key_gemini')||'', 
                groq: localStorage.getItem('nova_key_groq')||'',
                cohere: localStorage.getItem('nova_key_cohere')||'',
                openai: localStorage.getItem('nova_key_openai')||'', 
                grok: localStorage.getItem('nova_key_grok')||'',
                serpapi: localStorage.getItem('nova_key_serpapi')||''
            },
            isThinking: false, isListening: false, isNoteListening: false, isSearchEnabled: false,
            isContinuous: false,
            manualLocIndex: 0,
            manualLocs: [{name: "å°åŒ—", lat: 25.0330, lon: 121.5654}, {name: "å°ä¸­", lat: 24.1477, lon: 120.6736}, {name: "é«˜é›„", lat: 22.6273, lon: 120.3014}],
            pendingReminder: null,
            reminderStage: 0 
        };
        
        // Update 1: Model Config (No Cerebras, Zeabur, OpenRouter)
        const MODEL_CONFIG = {
            gemini: { name: 'Gemini', color: 'text-blue-400', bg: 'bg-blue-600', icon: 'ph-globe' },
            grok: { name: 'Grok', color: 'text-slate-100', bg: 'bg-slate-600', icon: 'ph-lightning' },
            groq: { name: 'Groq', color: 'text-rose-400', bg: 'bg-rose-600', icon: 'ph-rocket' },
            cohere: { name: 'Cohere', color: 'text-violet-400', bg: 'bg-violet-600', icon: 'ph-cpu' },
            gpt: { name: 'OpenAI', color: 'text-emerald-400', bg: 'bg-emerald-600', icon: 'ph-cpu' }
        };

        // --- UTILS ---
        function saveMessages() { localStorage.setItem('nova_messages', JSON.stringify(appState.messages)); }
        function saveData() { localStorage.setItem('nova_todos', JSON.stringify(appState.todos)); localStorage.setItem('nova_notes', JSON.stringify(appState.notes)); }
        function getTime() { return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        function formatMessage(text) { if (!text) return ''; let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); safe = safe.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-bold">$1</strong>'); safe = safe.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-blue-400 underline break-all">$1</a>'); return safe.replace(/\n/g, '<br>'); }
        function escapeHtml(t){return t?t.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">"):""}

        // --- GLOBAL HANDLERS ---
        function handleEnter(e) { if(e.key==='Enter') handleSendMessage(); }

        // --- RENDERERS ---
        function renderAll() { renderMessages(); renderTodos(); renderNotes(); renderWeather(); }
        function renderMessages() { 
            const container = document.getElementById('chat-container');
            if(!container) return;
            container.innerHTML = appState.messages.map(msg => { 
                const isUser = msg.sender === 'user'; 
                const modelInfo = isUser ? null : MODEL_CONFIG[msg.model]; 
                let sourcesHTML = ''; 
                if (msg.sources?.length) sourcesHTML = `<div class="mt-3 pt-3 border-t border-slate-700/50"><p class="text-[10px] text-slate-400 mb-1 font-bold">ä¾†æºï¼š</p><div class="flex flex-wrap gap-2">${msg.sources.map((s,i)=>`<a href="${s.uri}" target="_blank" class="text-[10px] bg-slate-950/50 text-blue-400 px-2 py-1 rounded border border-slate-700/50 block truncate max-w-[150px]">${i+1}. ${s.title}</a>`).join('')}</div></div>`; 
                return `<div class="group flex ${isUser ? 'justify-end' : 'justify-start items-start space-x-3'} fade-in relative mb-4">
                    ${!isUser ? `<div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1 ${modelInfo?.bg||'bg-slate-700'}"><i class="ph-fill ${modelInfo?.icon||'ph-robot'} text-white text-sm"></i></div>` : ''}
                    <div class="msg-group relative max-w-[90%] md:max-w-[80%] rounded-2xl p-4 shadow-sm ${isUser ? 'bg-slate-800 text-white rounded-br-none' : 'bg-slate-900 border border-slate-800 text-slate-200 rounded-tl-none'}">
                        ${!isUser ? `<span class="text-[10px] font-bold uppercase mb-1 block ${modelInfo?.color||'text-slate-400'} opacity-80">${modelInfo?.name||'System'}</span>` : ''}
                        <div class="msg-content text-sm leading-relaxed">${formatMessage(msg.text, msg.isHtml)}</div>
                        ${sourcesHTML}
                        <p class="text-[10px] mt-2 text-right text-slate-500 opacity-60">${msg.time}</p>
                        <button onclick="deleteMessage(${msg.id})" class="msg-actions absolute top-2 right-2 p-1 text-slate-500 hover:text-red-400 transition-colors bg-slate-950/50 rounded-full"><i class="ph-bold ph-trash text-xs"></i></button>
                    </div>
                </div>`; 
            }).join(''); 
            container.scrollTop = container.scrollHeight; 
        }

        function renderThinkingState(show) { 
            const el = document.getElementById('thinking-indicator'); 
            const container = document.getElementById('chat-container');
            if(show && !el && container) container.insertAdjacentHTML('beforeend', `<div id="thinking-indicator" class="flex justify-start items-center space-x-3 fade-in"><div class="w-8 h-8 rounded-full flex items-center justify-center ${MODEL_CONFIG[appState.currentModel]?.bg || 'bg-slate-700'}"><i class="ph-fill ${MODEL_CONFIG[appState.currentModel]?.icon || 'ph-robot'} text-white text-sm"></i></div><div class="bg-slate-900 border border-slate-800 p-4 rounded-2xl rounded-tl-none"><div class="dot-flashing ml-2"></div></div></div>`); 
            else if(!show && el) el.remove(); 
        }

        function renderTodos() { 
            const el = document.getElementById('full-todo-list');
            if(!el) return;
            el.innerHTML=appState.todos.map(t=>`<div class="group bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between hover:border-slate-600 transition-all slide-in"><div class="flex items-center space-x-4"><button onclick="toggleTodo(${t.id})" class="text-slate-500 hover:text-blue-400"><i class="ph${t.done?'-fill ph-check-circle text-green-500':' ph-circle'} text-2xl"></i></button><div><p class="text-base ${t.done?'line-through text-slate-600':'text-slate-200'}">${escapeHtml(t.text)}</p><span class="text-xs text-slate-500">${t.time}</span></div></div><button onclick="deleteTodo(${t.id})" class="text-slate-500 hover:text-red-400 p-2"><i class="ph ph-trash"></i></button></div>`).join('')||'<p class="text-slate-500 text-center mt-10">ç„¡ä»»å‹™</p>'; 
            const mini = document.getElementById('mini-todo-list');
            if(mini) mini.innerHTML=appState.todos.slice(0,3).map(t=>`<div class="flex items-center space-x-3 p-2 bg-slate-950/50 rounded-lg border border-slate-800/50"><div class="w-1.5 h-8 rounded-full ${t.done?'bg-green-500':'bg-blue-500'}"></div><div class="flex-1 min-w-0"><p class="text-xs truncate ${t.done?'line-through text-slate-600':'text-slate-300'}">${escapeHtml(t.text)}</p></div></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ç„¡å¾…è¾¦</p>'; 
        }

        function renderNotes() { 
            const el = document.getElementById('full-note-list');
            if(!el) return;
            el.innerHTML=appState.notes.map(n=>`<div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 hover:border-slate-600 flex flex-col h-48 relative overflow-hidden slide-in"><div class="flex justify-between mb-2"><h3 class="text-lg font-bold text-white truncate pr-2">${escapeHtml(n.title)}</h3><span class="text-xs text-slate-500 whitespace-nowrap">${n.date}</span></div><p class="text-slate-300 text-sm overflow-y-auto flex-1 scrollbar-thin">${escapeHtml(n.content)}</p><button onclick="deleteNote(${n.id})" class="absolute bottom-4 right-4 text-slate-600 hover:text-red-400"><i class="ph ph-trash text-lg"></i></button></div>`).join('')||'<p class="text-slate-500 text-center col-span-3 mt-10">ç„¡ç­†è¨˜</p>'; 
            const mini = document.getElementById('mini-note-list');
            if(mini) mini.innerHTML=appState.notes.slice(0,2).map(n=>`<div class="bg-slate-950/50 p-3 rounded-lg border border-slate-800/50 cursor-pointer hover:border-slate-700" onclick="switchTab('notes')"><h4 class="text-slate-300 text-xs font-bold mb-1 truncate">${escapeHtml(n.title)}</h4><p class="text-slate-500 text-[10px] line-clamp-1">${escapeHtml(n.content)}</p></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ç„¡ç­†è¨˜</p>'; 
        }

        function renderWeather() { 
            const {temp,condition,humidity,wind,loc}=appState.weather; 
            let icon='ph-cloud',color='text-slate-400',desc='å¤šé›²'; 
            if(condition==='sunny'){icon='ph-sun';color='text-yellow-400';desc='æ™´æœ—';} 
            if(condition==='rainy'){icon='ph-cloud-rain';color='text-blue-400';desc='æœ‰é›¨';} 
            
            const locEl = document.getElementById('location-name'); 
            if(locEl) locEl.innerText=loc; 
            
            const tempEl = document.getElementById('weather-temp'); 
            if(tempEl) tempEl.innerText=`${temp}Â°`; 
            
            const descEl = document.getElementById('weather-desc'); 
            if(descEl) descEl.innerText=desc; 
            
            const iconEl = document.getElementById('weather-icon'); 
            if(iconEl) iconEl.className=`ph-fill ${icon} text-4xl ${color}`; 
            
            const humEl = document.getElementById('weather-humidity'); 
            if(humEl) humEl.innerText=`æ¿•åº¦ ${humidity}%`; 
            
            const windEl = document.getElementById('weather-wind'); 
            if(windEl) windEl.innerText=`é¢¨é€Ÿ ${wind}km/h`; 
            
            const mTemp = document.getElementById('mobile-weather-temp'); 
            if(mTemp) mTemp.innerText=loc==='æœªå®šä½'?'å®šä½':`${temp}Â°`; 
            
            const mIcon = document.getElementById('mobile-weather-icon'); 
            if(mIcon) mIcon.className=`ph-fill ${loc==='æœªå®šä½'?'ph-navigation-arrow':icon} ${color}`; 
        }

        function updateModelUI(){ 
            const conf=MODEL_CONFIG[appState.currentModel]; 
            const statusName = document.getElementById('status-name'); if(statusName) statusName.innerText=conf?.name || 'Unknown'; 
            const statusIcon = document.getElementById('status-icon'); if(statusIcon) statusIcon.className=`ph-fill ${conf?.icon || 'ph-cpu'} text-lg ${conf?.color || 'text-slate-400'}`; 
            
            const selectEl = document.getElementById('main-model-select');
            if(selectEl) selectEl.value = appState.currentModel;
            
            const wrap = document.getElementById('input-wrapper'); if(wrap) wrap.className = `flex items-center bg-slate-950 rounded-xl px-2 py-2 border transition-colors border-slate-700 focus-within:border-${appState.currentModel==='gemini'?'blue':appState.currentModel==='groq'?'rose':appState.currentModel==='cohere'?'violet':appState.currentModel==='gpt'?'emerald':'slate'}-500`; 
            
            const badge=document.getElementById('web-search-badge'); const searchBtn=document.getElementById('search-toggle-btn'); const hint=document.getElementById('search-hint'); 
            if(searchBtn) {
                if(appState.isSearchEnabled){ searchBtn.classList.add('text-blue-400','bg-blue-900/30'); searchBtn.classList.remove('text-slate-500'); if(badge)badge.classList.remove('hidden'); if(hint)hint.classList.remove('hidden'); }
                else{ searchBtn.classList.remove('text-blue-400','bg-blue-900/30'); searchBtn.classList.add('text-slate-500'); if(badge)badge.classList.add('hidden'); if(hint)hint.classList.add('hidden'); }
            }
            if(appState.currentModel!=='gemini'&&appState.isSearchEnabled){setModel('gemini');} 
        }

        // --- EXPORT / IMPORT SETTINGS (NEW) ---
        function exportSettings() {
            const data = {
                keys: appState.keys,
                urls: {
                    docMonitorUrl: appState.docMonitorUrl,
                    noteDocUrl: appState.noteDocUrl,
                    noteDocUrl2: appState.noteDocUrl2,
                    driveUrl: appState.driveUrl
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NOVA12_Settings_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerImportSettings() {
            document.getElementById('import-settings-input').click();
        }

        function importSettings(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    if (data.keys) {
                        appState.keys.gemini = data.keys.gemini || '';
                        appState.keys.groq = data.keys.groq || '';
                        appState.keys.cohere = data.keys.cohere || '';
                        appState.keys.openai = data.keys.openai || '';
                        appState.keys.grok = data.keys.grok || '';
                        appState.keys.serpapi = data.keys.serpapi || '';
                    }
                    if (data.urls) {
                        appState.docMonitorUrl = data.urls.docMonitorUrl || '';
                        appState.noteDocUrl = data.urls.noteDocUrl || '';
                        appState.noteDocUrl2 = data.urls.noteDocUrl2 || '';
                        appState.driveUrl = data.urls.driveUrl || '';
                    }
                    
                    const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                    safeSet('key-gemini', appState.keys.gemini);
                    safeSet('key-groq', appState.keys.groq);
                    safeSet('key-cohere', appState.keys.cohere);
                    safeSet('key-openai', appState.keys.openai);
                    safeSet('key-grok', appState.keys.grok);
                    safeSet('key-serpapi', appState.keys.serpapi);
                    safeSet('key-doc-url', appState.docMonitorUrl);
                    safeSet('key-note-doc-url', appState.noteDocUrl);
                    safeSet('key-note-doc-url-2', appState.noteDocUrl2);
                    safeSet('key-drive-url', appState.driveUrl);
                    
                    alert("è¨­å®šåŒ¯å…¥æˆåŠŸï¼è«‹é»æ“Šå³ä¸‹è§’ã€Œå„²å­˜ã€æŒ‰éˆ•ä¾†å¥—ç”¨è¨­å®šã€‚");
                } catch(err) {
                    alert("è¨­å®šæª”è§£æå¤±æ•—ï¼š" + err.message);
                }
                e.target.value = ''; 
            };
            reader.readAsText(file);
        }

        // --- ACTIONS ---
        function addMessage(text, sender, model, sources=[]) { appState.messages.push({id:Date.now(), text, sender, model, sources, time:getTime()}); saveMessages(); renderMessages(); }
        function deleteMessage(id) { appState.messages = appState.messages.filter(m => m.id !== id); saveMessages(); renderMessages(); }
        function clearChatHistory() { if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å°è©±ç´€éŒ„å—ï¼Ÿ")) { appState.messages = []; saveMessages(); renderMessages(); } }
        function toggleTodo(id){ const t=appState.todos.find(x=>x.id===id); if(t){t.done=!t.done;saveData();renderTodos();} }
        function deleteTodo(id){ appState.todos=appState.todos.filter(x=>x.id!==id); saveData(); renderTodos(); }
        function deleteNote(id){ appState.notes=appState.notes.filter(x=>x.id!==id); saveData(); renderNotes(); }
        function addTodoManually(){ const t=prompt("ä»»å‹™"); if(t){appState.todos.push({id:Date.now(),text:t,done:false,time:'æ‰‹å‹•'});saveData();renderTodos();} }
        function addNoteManually(){ const t=prompt("æ¨™é¡Œ"),c=prompt("å…§å®¹"); if(t&&c){appState.notes.push({id:Date.now(),title:t,content:c,date:new Date().toLocaleDateString()});saveData();renderNotes();} }
        function switchTab(id){ ['dashboard','schedule','notes'].forEach(t=>document.getElementById(`view-${t}`).classList.add('hidden')); document.getElementById(`view-${id}`).classList.remove('hidden'); document.getElementById(`view-${id}`).classList.add('flex'); document.querySelectorAll('.nav-item').forEach(b=>{b.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 transition-all';}); const active=document.getElementById(`nav-${id}`); if(active)active.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all'; }
        function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');}
        function closeSettings(){document.getElementById('settings-modal').classList.add('hidden');}
        
        // Fix: Robust saveKeys to prevent null errors from removed DOM elements
        function saveKeys(){ 
            const safeGetVal = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
            
            appState.keys.gemini = safeGetVal('key-gemini'); 
            appState.keys.groq = safeGetVal('key-groq');
            appState.keys.cohere = safeGetVal('key-cohere');
            appState.keys.openai = safeGetVal('key-openai'); 
            appState.keys.grok = safeGetVal('key-grok'); 
            appState.keys.serpapi = safeGetVal('key-serpapi'); 
            appState.docMonitorUrl = safeGetVal('key-doc-url'); 
            appState.noteDocUrl = safeGetVal('key-note-doc-url'); 
            appState.noteDocUrl2 = safeGetVal('key-note-doc-url-2'); 
            appState.driveUrl = safeGetVal('key-drive-url'); 
            
            localStorage.setItem('nova_key_gemini', appState.keys.gemini); 
            localStorage.setItem('nova_key_groq', appState.keys.groq); 
            localStorage.setItem('nova_key_cohere', appState.keys.cohere); 
            localStorage.setItem('nova_key_openai', appState.keys.openai); 
            localStorage.setItem('nova_key_grok', appState.keys.grok); 
            localStorage.setItem('nova_key_serpapi', appState.keys.serpapi); 
            localStorage.setItem('nova_doc_url', appState.docMonitorUrl); 
            localStorage.setItem('nova_note_doc_url', appState.noteDocUrl); 
            localStorage.setItem('nova_note_doc_url_2', appState.noteDocUrl2); 
            localStorage.setItem('nova_drive_url', appState.driveUrl); 
            
            appState.detectedGeminiModel = null; 
            updateModelUI(); 
            startDocMonitor(); 
            closeSettings(); 
            addMessage("è¨­å®šå·²å„²å­˜", 'system'); 
        }
        function setModel(m){ appState.currentModel=m; updateModelUI(); }
        function toggleMobileMenu(){document.getElementById('mobile-menu').classList.toggle('hidden');}
        function updateSendButtonState(isLoading) { const btn=document.getElementById('send-btn'),icon=document.getElementById('send-icon'); if(isLoading){btn.classList.add('cursor-not-allowed','opacity-70');icon.classList.remove('ph-paper-plane-right');icon.classList.add('ph-spinner','animate-spin');}else{btn.classList.remove('cursor-not-allowed','opacity-70');icon.classList.remove('ph-spinner','animate-spin');icon.classList.add('ph-paper-plane-right');} }
        function toggleSearch() { appState.isSearchEnabled = !appState.isSearchEnabled; updateModelUI(); }
        function cycleManualLocation() { appState.manualLocIndex = (appState.manualLocIndex + 1) % appState.manualLocs.length; const loc = appState.manualLocs[appState.manualLocIndex]; fetchWeather(loc.lat, loc.lon, loc.name + " (æ‰‹å‹•)", false); }
        async function tryGetLocation(silent=false) { if(!silent) updateLocStatus("GPS..."); if (navigator.geolocation) { navigator.geolocation.getCurrentPosition((p) => fetchWeather(p.coords.latitude, p.coords.longitude, "GPS", silent), (e) => getIPLocation(silent), { timeout: 5000 }); } else getIPLocation(silent); }
        async function getIPLocation(silent) { if(!silent) updateLocStatus("IP..."); try { const res = await fetch('https://ipapi.co/json/'); if(!res.ok)throw new Error(); const data=await res.json(); fetchWeather(data.latitude, data.longitude, `${data.city}(IP)`, silent); } catch(e){ try { const res2 = await fetch('https://ipwho.is/'); const data2 = await res2.json(); if(!data2.success)throw new Error(); fetchWeather(data2.latitude, data2.longitude, `${data2.city}(IP)`, silent); } catch(e2) { updateLocStatus("å¤±æ•—"); if(!silent) addMessage("âš ï¸ å®šä½å¤±æ•—ï¼Œå·²åˆ‡æ›è‡³é è¨­åŸå¸‚", "system"); const def = appState.manualLocs[0]; fetchWeather(def.lat, def.lon, def.name + " (é è¨­)", true); } } }
        async function fetchWeather(lat, lon, locName, silent) { try { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`; const res = await fetch(url); const data = await res.json(); if(data.current) { const c = data.current; appState.weather = { temp: Math.round(c.temperature_2m), humidity: c.relative_humidity_2m, wind: c.wind_speed_10m, condition: wmoToCondition(c.weather_code), loc: locName }; renderWeather(); updateLocStatus("å·²æ›´æ–°"); if(!silent) addMessage(`âœ… å¤©æ°£å·²æ›´æ–°: ${c.temperature_2m}Â°C`, "system"); } } catch(e) { updateLocStatus("éŒ¯èª¤"); } }
        function updateLocStatus(msg) { 
            const el = document.getElementById('location-status'); 
            if(el) el.innerText = msg; 
            if(msg==="å·²æ›´æ–°"||msg.includes("é è¨­")||msg.includes("æ‰‹å‹•")) { 
                const {loc, temp} = appState.weather; 
                const locName = document.getElementById('location-name'); if(locName) locName.innerText = loc; 
                const mTemp = document.getElementById('mobile-weather-temp'); if(mTemp) mTemp.innerText = `${temp}Â°`; 
            } 
        }
        function wmoToCondition(c) { if(c===0)return 'sunny'; if(c<=48)return 'cloudy'; if(c<=82)return 'rainy'; if(c<=77)return 'snow'; return 'storm'; }

        // --- GLOBAL ACTIONS (Moved to top level) ---
        function toggleVoice() { 
            if (!recognition) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
            if (appState.isListening) {
                appState.isContinuous = false; 
                document.getElementById('continuous-btn').classList.remove('text-emerald-400', 'animate-pulse');
                document.getElementById('continuous-btn').classList.add('text-slate-500');
                document.getElementById('continuous-icon').classList.remove('animate-spin-slow'); 
                
                recognition.stop();
                if(voiceTimer) clearTimeout(voiceTimer);
            } else {
                const input = document.getElementById('user-input');
                initialInput = input.value; 
                recognition.start();
            }
        }
        
        function toggleContinuous() {
            appState.isContinuous = !appState.isContinuous;
            const btn = document.getElementById('continuous-btn');
            const icon = document.getElementById('continuous-icon');
            
            if (appState.isContinuous) {
                btn.classList.remove('text-slate-500');
                btn.classList.add('text-emerald-400', 'bg-emerald-900/30', 'animate-pulse');
                icon.classList.add('animate-spin-slow'); 
                addMessage("ğŸ”„ å·²é–‹å•Ÿé€£çºŒå°è©±æ¨¡å¼ï¼šèªªå®Œè©±å¾Œ6ç§’è‡ªå‹•ç™¼é€ï¼Œéº¥å…‹é¢¨å°‡æŒçºŒé–‹å•Ÿã€‚", "system");
                
                if (!appState.isListening && recognition) {
                    initialInput = document.getElementById('user-input').value;
                    recognition.start();
                }
            } else {
                btn.classList.add('text-slate-500');
                btn.classList.remove('text-emerald-400', 'bg-emerald-900/30', 'animate-pulse');
                icon.classList.remove('animate-spin-slow');
                addMessage("â¹ï¸ å·²é—œé–‰é€£çºŒå°è©±æ¨¡å¼ã€‚", "system");
                if (appState.isListening && recognition) {
                    recognition.stop();
                }
            }
        }

        function updateVoiceUI() { 
            const btn=document.getElementById('voice-btn'),icon=document.getElementById('voice-icon'); 
            if(appState.isListening){btn.classList.add('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone','ph-microphone-stage');}
            else{btn.classList.remove('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone-stage','ph-microphone');} 
        }
        function toggleNoteVoice() { 
            if (!noteRecognition) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
            if (appState.isNoteListening) noteRecognition.stop(); 
            else noteRecognition.start(); 
        }
        function updateNoteVoiceUI() { 
            const btn=document.getElementById('note-voice-btn'),icon=document.getElementById('note-voice-icon'); 
            if(appState.isNoteListening){btn.classList.add('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone','ph-microphone-stage');}
            else{btn.classList.remove('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone-stage','ph-microphone');} 
        }

        // --- NOTEBOOK 2 LOGIC ---
        function setActiveNotebook(num) {
            appState.activeNotebook = num;
            const btn1 = document.getElementById('btn-nb-1');
            const btn2 = document.getElementById('btn-nb-2');
            const label = document.getElementById('active-notebook-label');
            
            if(num === 1) {
                btn1.classList.add('bg-emerald-600', 'text-white');
                btn1.classList.remove('text-slate-400', 'hover:text-white');
                btn2.classList.remove('bg-teal-600', 'text-white');
                btn2.classList.add('text-slate-400', 'hover:text-white');
                label.innerText = '* ç›®å‰å¯«å…¥ç›®æ¨™ï¼šç­†è¨˜æœ¬ A (URL 1)';
            } else {
                btn2.classList.add('bg-teal-600', 'text-white');
                btn2.classList.remove('text-slate-400', 'hover:text-white');
                btn1.classList.remove('bg-emerald-600', 'text-white');
                btn1.classList.add('text-slate-400', 'hover:text-white');
                label.innerText = '* ç›®å‰å¯«å…¥ç›®æ¨™ï¼šç­†è¨˜æœ¬ B (URL 2)';
            }
        }

        // --- PHOTO LOGIC ---
        function triggerPhotoUpload() { document.getElementById('photo-input').click(); }
        function triggerCameraUpload() { document.getElementById('camera-input').click(); }
        
        function handlePhotoSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                appState.pastedImageBase64 = evt.target.result;
                const indicator = document.getElementById('paste-indicator');
                if(indicator) indicator.classList.remove('hidden');
                const docInput = document.getElementById('doc-input-main');
                docInput.value = "[å·²åµæ¸¬åˆ°é¸æ“‡çš„åœ–ç‰‡ï¼Œè«‹é»æ“Šã€Œç™¼é€å¯«å…¥ã€æŒ‰éˆ•ä¸Šå‚³]";
            };
            reader.readAsDataURL(file);
        }

        // --- AUDIO RECORDING ---
        async function startAudioRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                addMessage("âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½", 'system');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = uploadAudioRecording;
                
                mediaRecorder.start();
                document.getElementById('recording-status').classList.remove('hidden');
                document.getElementById('recording-status').classList.add('flex');
                addMessage("ğŸ™ï¸ é–‹å§‹éŒ„éŸ³...", 'system');
            } catch (err) {
                console.error("Recording error:", err);
                addMessage("âš ï¸ ç„¡æ³•å•Ÿå‹•éŒ„éŸ³ï¼Œè«‹æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™", 'system');
            }
        }

        function stopAudioRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('recording-status').classList.add('hidden');
                document.getElementById('recording-status').classList.remove('flex');
                addMessage("â¹ï¸ éŒ„éŸ³çµæŸï¼Œè™•ç†ä¸­...", 'system');
            }
        }

        async function uploadAudioRecording() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `${dateStr}-Audio.webm`;
            
            if (!appState.driveUrl) {
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                addMessage(`âš ï¸ æœªè¨­å®š Drive ä¸Šå‚³ URLï¼Œå·²è‡ªå‹•ä¸‹è¼‰æª”æ¡ˆ: ${filename}`, 'system');
                return;
            }

            addMessage(`â˜ï¸ æ­£åœ¨ä¸Šå‚³ ${filename} åˆ° Google Drive...`, 'system');
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async function() {
                const base64data = reader.result.split(',')[1];
                try {
                    const res = await fetch(appState.driveUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: filename,
                            mimeType: 'audio/webm',
                            data: base64data
                        })
                    });
                    addMessage(`âœ… éŒ„éŸ³å·²ç™¼é€è‡³é›²ç«¯ç¡¬ç¢Ÿæ’ç¨‹ (è‹¥å¤±æ•—è«‹æª¢æŸ¥ Apps Script è¨­å®š)`, 'system');
                } catch (e) {
                    addMessage(`âŒ ä¸Šå‚³å¤±æ•—: ${e.message}`, 'system');
                }
            };
        }

        // --- WEB SCRAPER ---
        async function fetchUrlViaGas(url) {
            if (!appState.docMonitorUrl) return null;
            try {
                const res = await fetch(appState.docMonitorUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ type: 'scrape_and_log', url: url })
                });
                const text = await res.text();
                if (text && !text.startsWith("Error")) return text;
                return null;
            } catch (e) {
                console.error("GAS Scrape Error:", e);
                return null;
            }
        }
        
        async function searchViaSerpApi(query) {
            if (!appState.keys.serpapi) return null;
            addMessage(`ğŸ” æ­£åœ¨é€é SerpApi (Google) æœå°‹ï¼š${query}...`, 'system');
            
            const targetUrl = `https://serpapi.com/search.json?q=${encodeURIComponent(query)}&api_key=${appState.keys.serpapi}&engine=google&gl=tw&hl=zh-tw`;
            
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`,
                `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`
            ];

            let serpData = null;
            let lastErrorMsg = "";

            for (const proxy of proxies) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    const res = await fetch(proxy, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!res.ok) {
                        lastErrorMsg = `HTTP ${res.status}`;
                        continue;
                    }

                    const data = await res.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    serpData = data;
                    break;
                } catch (err) {
                    lastErrorMsg = err.name === 'AbortError' ? 'é€£ç·šé€¾æ™‚' : err.message;
                    console.warn("Proxy attempt failed:", proxy, lastErrorMsg);
                    if (err.message && err.message.toLowerCase().includes("invalid api key")) {
                        throw new Error("SerpApi é‡‘é‘°ç„¡æ•ˆæˆ–å·²è€—ç›¡");
                    }
                }
            }

            if (!serpData) {
                throw new Error(`SerpApi ä»£ç†é€£ç·šçš†å¤±æ•— (${lastErrorMsg})`);
            }
            
            let resultText = "ã€SerpApi æœå°‹çµæœã€‘\n";
            if (serpData.organic_results && serpData.organic_results.length > 0) {
                serpData.organic_results.slice(0, 5).forEach((item, index) => {
                    resultText += `${index + 1}. [${item.title}](${item.link})\n   ${item.snippet || ''}\n`;
                });
            } else {
                resultText += "æœªæ‰¾åˆ°ç›¸é—œçµæœã€‚";
            }
            
            return resultText;
        }
        
        async function searchViaGas(query) {
             if (!appState.docMonitorUrl) return null;
             
             try {
                addMessage(`ğŸ” æ­£åœ¨é€é Google News/Wiki æœå°‹ï¼š${query}...`, 'system');
                const res = await fetch(appState.docMonitorUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ type: 'search', query: query })
                });
                const text = await res.text();
                if (text && !text.startsWith("Error")) return text;
                return "æœå°‹å¤±æ•—æˆ–ç„¡çµæœ";
            } catch (e) {
                console.error("GAS Search Error:", e);
                return "æœå°‹é€£ç·šéŒ¯èª¤";
            }
        }

        async function extractContentFromUrl(url) {
            if (appState.docMonitorUrl) {
                const gasContent = await fetchUrlViaGas(url);
                if (gasContent) return gasContent;
            }
            try {
                if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('facebook.com') || url.includes('twitter.com') || url.includes('x.com')) return null;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                const data = await res.json();
                if (!data.contents) return null;
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                const scripts = doc.querySelectorAll('script, style, nav, footer, header, aside, iframe, noscript');
                scripts.forEach(node => node.remove());
                let text = doc.body.innerText || "";
                text = text.replace(/\s+/g, ' ').trim();
                return text.substring(0, 15000); 
            } catch (e) { return null; }
        }

        // --- PASTE HANDLER ---
        function handlePaste(e) {
            const items = (e.clipboardData || window.clipboardData).items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        appState.pastedImageBase64 = event.target.result;
                        const indicator = document.getElementById('paste-indicator');
                        if(indicator) indicator.classList.remove('hidden');
                        const docInput = document.getElementById('doc-input-main');
                        if(docInput) docInput.value = "[å·²åµæ¸¬åˆ°å‰ªè²¼ç°¿åœ–ç‰‡ï¼Œè«‹é»æ“Šã€Œç™¼é€å¯«å…¥ã€æŒ‰éˆ•ä¸Šå‚³]";
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault(); 
                    return;
                }
            }
        }
        
        function handleNoteKeydown(e) {
            if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;
            
            if (appState.pastedImageBase64) {
                 const docInput = document.getElementById('doc-input-main');
                 if (docInput.value === "[å·²åµæ¸¬åˆ°å‰ªè²¼ç°¿åœ–ç‰‡ï¼Œè«‹é»æ“Šã€Œç™¼é€å¯«å…¥ã€æŒ‰éˆ•ä¸Šå‚³]" || docInput.value === "[å·²åµæ¸¬åˆ°é¸æ“‡çš„åœ–ç‰‡ï¼Œè«‹é»æ“Šã€Œç™¼é€å¯«å…¥ã€æŒ‰éˆ•ä¸Šå‚³]") {
                     appState.pastedImageBase64 = null;
                     document.getElementById('paste-indicator').classList.add('hidden');
                     docInput.value = "";
                 }
            }
            if (e.ctrlKey && e.key === 'Enter') {
                handleDocWriteBtn();
            }
        }
        
        function clearNoteInput() {
             document.getElementById('doc-input-main').value = '';
             document.getElementById('doc-input-sub').value = '';
             appState.pastedImageBase64 = null;
             document.getElementById('paste-indicator').classList.add('hidden');
        }

        function setWriteMode(mode) {
            appState.writeMode = mode;
            ['text', 'image', 'link'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if(m === mode) btn.className = 'text-xs px-3 py-1 rounded-full bg-blue-600 text-white font-bold transition-all';
                else btn.className = 'text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all';
            });
            const mainInput = document.getElementById('doc-input-main');
            const subInput = document.getElementById('doc-input-sub');
            
            if(mode === 'text') {
                mainInput.placeholder = "è¼¸å…¥æ–‡å­—å…§å®¹ï¼Œæˆ–ç›´æ¥ Ctrl+V è²¼ä¸Šåœ–ç‰‡...";
                subInput.classList.add('hidden');
            } else if (mode === 'image') {
                mainInput.placeholder = "è¼¸å…¥åœ–ç‰‡ç¶²å€ (https://...)";
                subInput.classList.add('hidden');
            } else if (mode === 'link') {
                mainInput.placeholder = "è¼¸å…¥é€£çµé¡¯ç¤ºæ–‡å­—";
                subInput.placeholder = "è¼¸å…¥é€£çµç¶²å€ (https://...)";
                subInput.classList.remove('hidden');
            }
        }

        async function handleDocWriteBtn() {
            const targetUrl = (appState.activeNotebook === 1) ? appState.noteDocUrl : appState.noteDocUrl2;
            
            if(!targetUrl) return alert(`è«‹å…ˆè‡³è¨­å®šè¼¸å…¥ã€Œéš¨æ‰‹è¨˜äº‹æœ¬ ${appState.activeNotebook === 1 ? 'A' : 'B'}ã€çš„ Apps Script URL`);
            
            const mainVal = document.getElementById('doc-input-main').value.trim();
            const subVal = document.getElementById('doc-input-sub').value.trim();
            const sendBtn = document.getElementById('note-send-btn');
            
            let payload = {};
            let currentMode = appState.writeMode;
            
            if ((currentMode === 'image' || currentMode === 'link') && !mainVal.match(/^https?:\/\//i) && mainVal.length > 0) {
                currentMode = 'text';
            }
            
            if (appState.pastedImageBase64 && (mainVal.includes("[å·²åµæ¸¬åˆ°"))) {
                payload = { type: 'image_base64', content: appState.pastedImageBase64 };
            } else {
                if(!mainVal && appState.writeMode !== 'image_base64') return; 
                
                if(currentMode === 'text') payload = { type: 'text', content: mainVal };
                else if (currentMode === 'image') payload = { type: 'image', content: mainVal };
                else if (currentMode === 'link') {
                    if(!subVal) return alert("è«‹è¼¸å…¥é€£çµç¶²å€");
                    payload = { type: 'link', text: mainVal, content: subVal };
                }
            }
            
            if(sendBtn) {
                const originalText = sendBtn.innerHTML;
                sendBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> â³ å¯«å…¥ä¸­...';
                sendBtn.classList.add('opacity-70', 'cursor-not-allowed');
                
                try {
                    await fetch(targetUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                    addMessage(`ğŸ“ å·²å¯«å…¥${appState.activeNotebook === 1 ? 'ç­†è¨˜æœ¬ A' : 'ç­†è¨˜æœ¬ B'}`, 'system');
                    clearNoteInput();
                } catch(e) { alert("å¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL"); }
                finally {
                    sendBtn.innerHTML = originalText;
                    sendBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            }
        }

        function openNoteDocViewer() { 
            const targetUrl = (appState.activeNotebook === 1) ? appState.noteDocUrl : appState.noteDocUrl2;
            if(!targetUrl) return alert(`è«‹å…ˆè¨­å®šéš¨æ‰‹è¨˜äº‹æœ¬ ${appState.activeNotebook === 1 ? 'A' : 'B'} URL`);
            document.getElementById('doc-viewer-modal').classList.remove('hidden'); 
            refreshNoteDocView(); 
        }
        function closeDocViewer() { document.getElementById('doc-viewer-modal').classList.add('hidden'); }
        
        async function refreshNoteDocView() {
            const area = document.getElementById('doc-content-area');
            const targetUrl = (appState.activeNotebook === 1) ? appState.noteDocUrl : appState.noteDocUrl2;
            
            area.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 gap-2"><div class="dot-flashing bg-slate-400"></div> è®€å–ä¸­...</div>';
            try {
                const res = await fetch(targetUrl);
                const text = await res.text();
                area.innerHTML = text || '<div class="text-center text-slate-400">è¨˜äº‹æœ¬æ˜¯ç©ºçš„</div>';
            } catch(e) { area.innerHTML = '<div class="text-center text-red-500">è®€å–å¤±æ•—</div>'; }
        }

        // --- HANDLERS & AI LOGIC ---
        async function handleSendMessage() {
            if(appState.isThinking) return;
            const input = document.getElementById('user-input');
            let text = input.value.trim();
            if (text.length > 4 && text.length % 2 === 0) {
                 const mid = text.length / 2;
                 if (text.substring(0, mid) === text.substring(mid)) { text = text.substring(0, mid); }
            }
            if(!text) return;

            // --- Voice Recording Commands ---
            if (text.includes("é–‹å§‹éŒ„éŸ³")) {
                input.value = ''; initialInput = '';
                addMessage(text, 'user');
                startAudioRecording();
                return;
            }
            if (text.includes("åœæ­¢éŒ„éŸ³")) {
                input.value = ''; initialInput = '';
                addMessage(text, 'user');
                stopAudioRecording();
                return;
            }

            appState.isThinking = true;
            updateSendButtonState(true);
            addMessage(text, 'user');
            
            input.value = '';
            initialInput = ''; 
            if (recognition && !appState.isContinuous) { recognition.stop(); }
            renderThinkingState(true);

            // --- REMINDER LOGIC ---
            if (appState.pendingReminder && appState.reminderStage > 0) {
                const todo = appState.todos.find(t => t.id === appState.pendingReminder);
                if (todo) {
                    let combinedText = todo.tempTimeStr ? `${todo.tempTimeStr} ${text}` : text;
                    const timeInfo = parseTimeNatural(combinedText);
                    
                    if (timeInfo.complete) {
                        todo.time = new Date(timeInfo.timestamp).toLocaleString();
                        todo.alertTime = timeInfo.timestamp;
                        todo.alerted = false;
                        delete todo.tempTimeStr;
                        appState.pendingReminder = null;
                        appState.reminderStage = 0;
                        addMessage(`ğŸ‘Œ å·²è¨­å®šæé†’ï¼š${todo.text} æ–¼ ${todo.time}`, 'system');
                    } else if (timeInfo.missing === 'date') {
                        todo.tempTimeStr = combinedText; 
                        addMessage(`è«‹å•æ˜¯ã€Œä»Šå¤©ã€ã€ã€Œæ˜å¤©ã€é‚„æ˜¯å“ªä¸€å¤©ï¼Ÿ`, 'system');
                        appState.reminderStage = 2; 
                    } else if (timeInfo.missing === 'ampm') {
                        todo.tempTimeStr = combinedText;
                        addMessage(`è«‹å•æ˜¯ã€Œä¸Šåˆã€é‚„æ˜¯ã€Œä¸‹åˆã€ï¼Ÿ`, 'system');
                        appState.reminderStage = 2;
                    } else {
                        addMessage(`ç„¡æ³•è­˜åˆ¥æ™‚é–“ï¼Œè«‹é‡è©¦ (ä¾‹å¦‚: æ˜å¤©ä¸‹åˆ3é»)`, 'system');
                    }
                    saveData(); renderTodos();
                }
                appState.isThinking = false; updateSendButtonState(false); renderThinkingState(false);
                return;
            }

            const reminderMatch = text.match(/^(?:æé†’|reminder)(.*)$/i);
            if (reminderMatch) {
                const content = reminderMatch[1].trim() || "æœªå‘½åäº‹é …";
                const newTodo = { id: Date.now(), text: content, done: false, time: 'è©¢å•ä¸­...', alerted: false };
                appState.todos.push(newTodo);
                appState.pendingReminder = newTodo.id;
                appState.reminderStage = 1; 
                saveData(); renderTodos();
                addMessage(`ğŸ“ å·²å°‡ã€Œ${content}ã€åŠ å…¥è¡Œç¨‹ï¼Œè«‹å•ä»€éº¼æ™‚å€™æé†’ï¼Ÿ`, 'system');
                appState.isThinking = false; updateSendButtonState(false); renderThinkingState(false);
                return;
            }

            try {
                let systemPromptAddon = "";
                let injectedContext = "";
                let modelToUse = appState.currentModel;
                let enableSearchTool = false;
                
                if (appState.isSearchEnabled) enableSearchTool = true;

                // --- SEARCH LOGIC ---
                const searchMatch = text.match(/^(?:æœå°‹|search)(.*)$/i);
                
                if (searchMatch) {
                    const searchKeyword = searchMatch[1].trim() || "ä»Šæ—¥æ–°è";
                    let searchResultText = "";
                    let usedSerp = false;

                    if (appState.keys.serpapi) {
                        try {
                            searchResultText = await searchViaSerpApi(searchKeyword);
                            usedSerp = true;
                        } catch (serpErr) {
                            addMessage(`âš ï¸ ${serpErr.message}ï¼Œæ­£åœ¨é€€å›ä½¿ç”¨å‚™ç”¨æœå°‹ã€‚`, 'system');
                        }
                    }
                    
                    if (!usedSerp && appState.docMonitorUrl) {
                        searchResultText = await searchViaGas(searchKeyword);
                    } else if (!usedSerp) {
                        if (appState.keys.gemini) {
                             modelToUse = 'gemini';
                             enableSearchTool = true;
                             systemPromptAddon += `(ç³»çµ±æŒ‡ä»¤: ä½¿ç”¨è€…æ­£åœ¨è¦æ±‚æœå°‹ã€‚è«‹å‹™å¿…ä½¿ç”¨ Google Search å·¥å…·æŸ¥æ‰¾ã€Œ${searchKeyword}ã€çš„æœ€æ–°è³‡è¨Šï¼Œä¸¦è©³ç´°å›ç­”ã€‚è‹¥æ‚¨ç„¡æ³•ä½¿ç”¨å·¥å…·ï¼Œè«‹èª å¯¦å‘ŠçŸ¥ã€‚)`;
                        } else {
                             throw new Error("ç„¡æ³•é€²è¡Œæœå°‹ï¼šæœªè¨­å®š SerpApi æˆ– Google Doc ä»£ç† URLï¼Œä¸”ç„¡ Gemini é‡‘é‘°å‚™æ´ã€‚");
                        }
                    }

                    if (searchResultText) {
                        addMessage(searchResultText, 'system');
                        let summaryModel = appState.currentModel;
                        if (summaryModel !== 'cohere' && summaryModel !== 'groq') {
                            if (appState.keys.cohere) summaryModel = 'cohere';
                            else if (appState.keys.groq) summaryModel = 'groq';
                        }
                        modelToUse = summaryModel;
                        text = `è«‹æ ¹æ“šä»¥ä¸‹æœå°‹çµæœï¼Œç”¨ç¹é«”ä¸­æ–‡ç‚ºæˆ‘åšä¸€ä»½é‡é»æ‘˜è¦ï¼š\n\n${searchResultText}`;
                        injectedContext = ""; systemPromptAddon = ""; enableSearchTool = false;
                    }
                } else {
                    const urlMatch = text.match(/https?:\/\/[^\s]+/);
                    if (urlMatch) {
                        const url = urlMatch[0];
                        if (!url.includes('youtube.com') && !url.includes('youtu.be') && !url.includes('twitter.com') && !url.includes('facebook.com')) {
                            addMessage(`ğŸ” æ­£åœ¨é€é Google Doc ä»£ç†æŠ“å–ç¶²é ...`, 'system');
                            const content = await fetchUrlViaGas(url);
                            if (content) {
                                injectedContext = `\n\n[ç³»çµ±: å·²é€é Google Doc æˆåŠŸæŠ“å–ç¶²é å…§å®¹ (${url})ï¼Œè«‹æ ¹æ“šä»¥ä¸‹å…§å®¹å›ç­”]:\n${content}\n\n`;
                                enableSearchTool = false; 
                            } else {
                                systemPromptAddon += `(ç³»çµ±: å˜—è©¦æŠ“å–ç¶²é å¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨æ‚¨çš„ Search å·¥å…·æœå°‹è©²ç¶²å€å…§å®¹)`;
                                if (appState.keys.gemini) { modelToUse = 'gemini'; enableSearchTool = true; }
                            }
                        } else if (url.includes('youtube') || url.includes('youtu.be')) {
                             if (appState.keys.gemini) {
                                modelToUse = 'gemini';
                                enableSearchTool = true; 
                                systemPromptAddon += `(ç³»çµ±: é€™æ˜¯ä¸€å€‹ YouTube é€£çµã€‚è«‹ä½¿ç”¨ Search å·¥å…·æœå°‹è©²å½±ç‰‡çš„æ¨™é¡Œã€æ‘˜è¦æˆ–è©•è«–å…§å®¹ä¾†å›ç­”ã€‚)`;
                             }
                        }
                    }
                }

                // --- API FALLBACK LOGIC ---
                let finalRes;
                let successfulModel = modelToUse;
                const promptToSent = `${text}\n${systemPromptAddon}\n${injectedContext}`;

                try {
                    finalRes = await fetchAIResponse(promptToSent, successfulModel, { enableSearch: enableSearchTool, disableSearch: !enableSearchTool && injectedContext !== "" });
                } catch (err1) {
                    console.warn(err1);
                    addMessage(`âš ï¸ ${MODEL_CONFIG[successfulModel]?.name || successfulModel} ç™¼ç”ŸéŒ¯èª¤ (${err1.message})ï¼Œå˜—è©¦åˆ‡æ›è‡³ Gemini...`, 'system');
                    successfulModel = 'gemini';
                    try {
                        finalRes = await fetchAIResponse(promptToSent, successfulModel, { enableSearch: enableSearchTool, disableSearch: !enableSearchTool && injectedContext !== "" });
                    } catch (err2) {
                        console.warn(err2);
                        addMessage(`âš ï¸ Gemini ç™¼ç”ŸéŒ¯èª¤ (${err2.message})ï¼Œå˜—è©¦åˆ‡æ›è‡³ Grok...`, 'system');
                        successfulModel = 'grok';
                        finalRes = await fetchAIResponse(promptToSent, successfulModel, { enableSearch: enableSearchTool, disableSearch: !enableSearchTool && injectedContext !== "" });
                    }
                }
                
                if(typeof finalRes === 'string') addMessage(finalRes, 'ai', successfulModel);
                else addMessage(finalRes.text, 'ai', successfulModel, finalRes.sources);

            } catch (error) {
                console.error("Handler Error:", error);
                addMessage(`[ç³»çµ±éŒ¯èª¤] ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'system');
            } finally {
                appState.isThinking = false;
                updateSendButtonState(false);
                renderThinkingState(false);
            }
        }

        async function fetchAIResponse(userText, model, options = {}) {
            const fetchWithTimeout = async (url, options, timeout = 30000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try { const response = await fetch(url, { ...options, signal: controller.signal }); clearTimeout(id); return response; } 
                catch (error) { clearTimeout(id); throw new Error(error.name === 'AbortError' ? 'é€£ç·šé€¾æ™‚ (30s)' : error.message); }
            };

            try {
                const key = appState.keys[model];
                if(!key) throw new Error(`æœªå¡«å¯« ${MODEL_CONFIG[model]?.name || model} API Key`);

                if(model === 'gemini') {
                    const modelName = 'gemini-2.5-flash';
                    const payload = { 
                        contents: [{ parts: [{ text: userText }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
                    };

                    if ((appState.isSearchEnabled || options.enableSearch) && !options.disableSearch) {
                        payload.tools = [{ google_search: {} }];
                    }

                    const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    const data = await res.json();
                    if (!res.ok) throw new Error(`${data.error?.message || res.status}`);

                    const candidate = data.candidates?.[0];
                    if (!candidate) return "âš ï¸ API æœªå›å‚³å…§å®¹ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";

                    let outputText = "";
                    if (candidate.content && candidate.content.parts) {
                        outputText = candidate.content.parts.filter(p => p.text).map(p => p.text).join("");
                    }

                    let sources = [];
                    if (candidate.groundingMetadata?.groundingAttributions) {
                        candidate.groundingMetadata.groundingAttributions.forEach(attr => {
                            if (attr.web?.uri) sources.push({ title: attr.web.title || "åƒè€ƒé€£çµ", uri: attr.web.uri });
                        });
                    }

                    if (!outputText && sources.length > 0) outputText = "å·²ç‚ºæ‚¨æœå°‹åˆ°ç›¸é—œè³‡è¨Šï¼Œè«‹åƒè€ƒä¾†æºé€£çµã€‚";
                    else if (!outputText) outputText = "(ç„¡å›å‚³æ–‡å­—å…§å®¹)";

                    return { text: outputText, sources: sources };
                    
                } else if (model === 'groq') {
                    const res = await fetchWithTimeout('https://api.groq.com/openai/v1/chat/completions', { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{ role: 'user', content: userText }] }) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error?.message || `Groq éŒ¯èª¤ (${res.status})`);
                    return data.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";
                } else if (model === 'cohere') {
                    const res = await fetchWithTimeout('https://api.cohere.com/v1/chat', { 
                        method: 'POST', 
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json', 'Accept': 'application/json' }, 
                        body: JSON.stringify({ model: 'command-r-plus-08-2024', message: userText }) 
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(`${data.message || res.status}`);
                    return data.text || "ç„¡å›æ‡‰";
                } else if (model === 'grok') {
                    const ep = 'https://api.x.ai/v1/chat/completions';
                    const mName = 'grok-4-1-fast-reasoning';
                    const res = await fetchWithTimeout(ep, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:mName, messages:[{role:"user", content:userText}]}) });
                    const data = await res.json(); 
                    if (!res.ok) throw new Error(`${data.error?.message || res.status}`);
                    return data.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";
                } else if (model === 'gpt') {
                    const ep = 'https://api.openai.com/v1/chat/completions';
                    const mName = 'gpt-4o-mini';
                    const res = await fetchWithTimeout(ep, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:mName, messages:[{role:"user", content:userText}]}) });
                    const data = await res.json(); 
                    if (!res.ok) throw new Error(`${data.error?.message || res.status}`);
                    return data.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";
                }
            } catch(e) { throw e; }
        }

        function playAlarmSound() {
            try {
                if (!alarmAudioCtx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) alarmAudioCtx = new AudioContext();
                }
                if (alarmAudioCtx && alarmAudioCtx.state === 'suspended') {
                    alarmAudioCtx.resume();
                }
                if (alarmAudioCtx) {
                    const osc = alarmAudioCtx.createOscillator();
                    const gain = alarmAudioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(alarmAudioCtx.destination);
                    
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, alarmAudioCtx.currentTime); 
                    osc.frequency.linearRampToValueAtTime(440, alarmAudioCtx.currentTime + 0.1);
                    osc.frequency.linearRampToValueAtTime(880, alarmAudioCtx.currentTime + 0.2);
                    
                    gain.gain.setValueAtTime(0.2, alarmAudioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, alarmAudioCtx.currentTime + 0.5);
                    
                    osc.start();
                    osc.stop(alarmAudioCtx.currentTime + 0.5);
                }
            } catch(e) { console.error("Audio play failed", e); }
        }

        function triggerAlarm(text) {
            const modal = document.getElementById('alarm-modal');
            const textEl = document.getElementById('alarm-text');
            if(modal && textEl) {
                textEl.innerText = text;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
                playAlarmSound();

                if(alarmInterval) clearInterval(alarmInterval);
                alarmInterval = setInterval(() => {
                    if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
                    playAlarmSound();
                }, 2000); 
            }
        }

        function stopAlarm() {
            const modal = document.getElementById('alarm-modal');
            if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            if(alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
            if(navigator.vibrate) navigator.vibrate(0);
        }
        
        function checkReminders() {
            const now = Date.now();
            let changed = false;
            appState.todos.forEach(todo => {
                if (todo.alertTime && !todo.alerted && !todo.done) {
                    if (now >= todo.alertTime) {
                        todo.alerted = true;
                        changed = true;
                        addMessage(`â° æé†’æ™‚é–“åˆ°ï¼š${todo.text}`, 'system');
                        triggerAlarm(todo.text); 
                    }
                }
            });
            if (changed) {
                saveData();
                renderTodos();
            }
        }

        // --- INIT ---
        window.onload = () => {
            if(appState.messages.length === 0) {
                appState.messages.push({ id: 1, text: 'NOVA 12 å°±ç·’ï¼\nå·²æ•´åˆå…¨æ–°ä¸‹æ‹‰é¸å–®ã€è¨­å®šæª”ç®¡ç†èˆ‡ API è‡ªå‹•å‚™æ´æ©Ÿåˆ¶ã€‚', sender: 'ai', model: 'gemini', time: getTime() });
            }
            renderAll();
            
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
            
            safeSet('key-gemini', appState.keys.gemini);
            safeSet('key-groq', appState.keys.groq);
            safeSet('key-cohere', appState.keys.cohere);
            safeSet('key-openai', appState.keys.openai);
            safeSet('key-grok', appState.keys.grok);
            safeSet('key-serpapi', appState.keys.serpapi);
            safeSet('key-doc-url', appState.docMonitorUrl);
            safeSet('key-note-doc-url', appState.noteDocUrl);
            safeSet('key-note-doc-url-2', appState.noteDocUrl2);
            safeSet('key-drive-url', appState.driveUrl);
            
            const inputMain = document.getElementById('doc-input-main');
            if(inputMain) inputMain.addEventListener('paste', handlePaste);
            
            setInterval(checkReminders, 10000);

            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) { 
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition; 
                
                recognition = new SR(); 
                recognition.lang = 'zh-TW'; 
                recognition.continuous = true; 
                recognition.interimResults = true; 
                
                let voiceTimer = null;
                let finalTranscript = ''; 
                
                recognition.onstart = () => {
                    appState.isListening = true;
                    updateVoiceUI();
                    const input = document.getElementById('user-input');
                    initialInput = input.value; 
                    finalTranscript = ''; 
                    if(input.value === '') input.placeholder = "è†è½ä¸­... (6ç§’å¾Œè‡ªå‹•ç™¼é€)";
                };
                
                recognition.onend = () => {
                    appState.isListening = false;
                    updateVoiceUI();
                    document.getElementById('user-input').placeholder = "è²¼ä¸Šç¶²å€è‡ªå‹•åˆ†æï¼Œæˆ–è¼¸å…¥ã€Œæœå°‹(å…§å®¹)ã€...";
                    
                    if(voiceTimer) {
                        clearTimeout(voiceTimer);
                        voiceTimer = null;
                        const input = document.getElementById('user-input');
                        if(input.value.trim() !== initialInput.trim()) {
                             handleSendMessage();
                        }
                    }

                    if (appState.isContinuous) {
                        recognition.start();
                    }
                };
                
                recognition.onresult = (e) => {
                    let transcript = "";
                    for (let i = 0; i < e.results.length; ++i) {
                        transcript += e.results[i][0].transcript;
                    }

                    if (transcript.length > 0) {
                         const len = transcript.length;
                         if (len % 2 === 0) {
                             if (transcript.substring(0, len/2) === transcript.substring(len/2)) {
                                 transcript = transcript.substring(0, len/2);
                             }
                         }
                         const split = transcript.split(' ');
                         if (split.length >= 2) {
                             const half = split.length / 2;
                             if (Number.isInteger(half)) {
                                 const firstHalf = split.slice(0, half).join(' ');
                                 const secondHalf = split.slice(half).join(' ');
                                 if (firstHalf === secondHalf) {
                                     transcript = firstHalf;
                                 }
                             }
                         }
                    }
                    
                    const input = document.getElementById('user-input');
                    input.value = initialInput + (initialInput && transcript ? " " : "") + transcript;
                    
                    if (voiceTimer) clearTimeout(voiceTimer);
                    voiceTimer = setTimeout(() => {
                        handleSendMessage(); 
                        voiceTimer = null;   
                        recognition.stop(); 
                    }, 6000);
                };
                
                noteRecognition = new SR();
                noteRecognition.lang = 'zh-TW';
                noteRecognition.continuous = true; 
                noteRecognition.interimResults = true;
                
                let noteVoiceTimer = null;
                let noteFinalTranscript = '';

                noteRecognition.onstart = () => { 
                    appState.isNoteListening = true; 
                    updateNoteVoiceUI(); 
                    const el = document.getElementById('doc-input-main');
                    initialInput = el.value;
                    noteFinalTranscript = '';
                    if (el.value === "[å·²åµæ¸¬åˆ°å‰ªè²¼ç°¿åœ–ç‰‡ï¼Œè«‹é»æ“Šã€Œç™¼é€å¯«å…¥ã€æŒ‰éˆ•ä¸Šå‚³]") {
                         appState.pastedImageBase64 = null;
                         document.getElementById('paste-indicator').classList.add('hidden');
                         el.value = "";
                         initialInput = "";
                    }
                };
                
                noteRecognition.onend = () => { 
                    appState.isNoteListening = false; 
                    updateNoteVoiceUI(); 
                    if(noteVoiceTimer) clearTimeout(noteVoiceTimer);
                };
                
                noteRecognition.onresult = (e) => {
                    let transcript = "";
                    for (let i = 0; i < e.results.length; ++i) {
                        transcript += e.results[i][0].transcript;
                    }

                    if (transcript.length > 0 && transcript.length % 2 === 0) {
                        const mid = transcript.length / 2;
                        if (transcript.substring(0, mid) === transcript.substring(mid)) {
                            transcript = transcript.substring(0, mid);
                        }
                    }
                    
                    const el = document.getElementById('doc-input-main');
                    const separator = (initialInput && transcript) ? "\n" : "";
                    el.value = initialInput + separator + transcript;
                    
                    if (noteVoiceTimer) clearTimeout(noteVoiceTimer);
                    noteVoiceTimer = setTimeout(() => {
                        noteRecognition.stop();
                    }, 6000);
                };
            }

            tryGetLocation(true);
            updateModelUI();
        };
    </script>
</body>
</html>
