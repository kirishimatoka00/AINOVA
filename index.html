<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NOVA 16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { slate: { 925: '#0f172a' } },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 2s linear infinite' }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ""; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -10px; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #9880ff; } 50%, 100% { background-color: rgba(152, 128, 255, 0.2); } }
        /* Enhanced content styling for Docs content */
        .msg-content a, #doc-content-area a { color: #60a5fa; text-decoration: underline; word-break: break-all; cursor: pointer; }
        .msg-content img, #doc-content-area img { max-width: 100%; height: auto; border-radius: 8px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); }
        .msg-content p, #doc-content-area div { margin-bottom: 0.5em; line-height: 1.6; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .msg-group:hover .msg-actions { opacity: 1; }
        .msg-actions { opacity: 0; transition: opacity 0.2s; }
        /* Recording Pulse */
        @keyframes recordPulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .recording-dot { animation: recordPulse 1.5s infinite; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans overflow-hidden selection:bg-blue-500/30">

    <div class="flex h-[100dvh] w-full">
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-slate-900 border-r border-slate-800 p-6 flex-shrink-0">
            <div class="flex items-center space-x-3 mb-10 px-2">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="ph-bold ph-infinity text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">NOVA 16</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Ultimate Edition</p>
                </div>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all"><i class="ph ph-chats-circle text-xl"></i><span class="font-medium">Âä©ÁêÜÂ∞çË©±</span></button>
                <button onclick="switchTab('schedule')" id="nav-schedule" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-calendar-check text-xl"></i><span class="font-medium">Ë°åÁ®ãÁÆ°ÁêÜ</span></button>
                <button onclick="switchTab('notes')" id="nav-notes" class="nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"><i class="ph ph-notebook text-xl"></i><span class="font-medium">Á≠ÜË®ò/Êñá‰ª∂</span></button>
            </nav>
            <div class="mt-auto space-y-3">
                <button onclick="openSettings()" class="flex items-center space-x-2 text-xs text-slate-500 hover:text-slate-300 w-full px-2"><i class="ph ph-gear"></i><span>Ë®≠ÂÆö & API</span></button>
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-center space-x-2"><i id="status-icon" class="ph-fill ph-globe text-blue-400 text-lg"></i><span id="status-name" class="font-bold text-sm">Gemini</span></div>
                    <p id="model-version-display" class="text-[10px] text-slate-500 mt-1">Ready</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-950 overflow-hidden min-h-0">
            <!-- Mobile Header -->
            <div class="md:hidden flex items-center justify-between p-3 bg-slate-900 border-b border-slate-800 z-30 shrink-0">
                <div class="flex items-center space-x-2"><i class="ph-bold ph-infinity text-blue-500 text-xl"></i><span class="font-bold text-white">Nova 16</span></div>
                <div class="flex items-center space-x-2 bg-slate-800/50 px-2 py-1 rounded-lg border border-slate-700/50 cursor-pointer active:scale-95 transition-transform" onclick="cycleManualLocation()">
                    <i id="mobile-weather-icon" class="ph-fill ph-navigation-arrow text-blue-400"></i><span id="mobile-weather-temp" class="text-xs font-bold text-white">Êõ¥Êñ∞</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="openSettings()"><i class="ph ph-gear text-slate-400 text-xl"></i></button>
                    <button onclick="toggleMobileMenu()"><i class="ph ph-list text-white text-2xl"></i></button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-slate-950/95 pt-20 px-6 backdrop-blur-md">
                <nav class="space-y-4">
                    <button onclick="switchTab('dashboard'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl bg-slate-800 text-white"><i class="ph ph-chats-circle text-xl"></i><span>Âä©ÁêÜÂ∞çË©±</span></button>
                    <button onclick="switchTab('schedule'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-calendar-check text-xl"></i><span>Ë°åÁ®ãÁÆ°ÁêÜ</span></button>
                    <button onclick="switchTab('notes'); toggleMobileMenu()" class="flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800"><i class="ph ph-notebook text-xl"></i><span>Á≠ÜË®ò/Êñá‰ª∂</span></button>
                </nav>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center mb-6 shrink-0"><h3 class="text-xl font-bold text-white">Ë®≠ÂÆö</h3><button onclick="closeSettings()"><i class="ph ph-x text-2xl text-slate-400"></i></button></div>
                    <div class="space-y-4 overflow-y-auto flex-1 pr-2">
                        
                        <!-- Docs Monitor Section -->
                        <div class="bg-gradient-to-r from-blue-900/30 to-indigo-900/30 p-4 rounded-xl border border-blue-500/50 shadow-inner space-y-4">
                            <div>
                                <label class="block text-xs text-blue-300 mb-2 font-bold flex items-center gap-2"><i class="ph-fill ph-robot"></i> Á≥ªÁµ±‰ª£ÁêÜ Google Doc (ÊêúÂ∞ã/Áà¨Ëü≤)</label>
                                <input type="text" id="key-doc-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs focus:border-blue-500 outline-none mb-2" placeholder="Apps Script URL (for Agent)">
                            </div>
                            
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <label class="block text-xs text-emerald-300 mb-1 font-bold"><i class="ph-fill ph-notebook"></i> Èö®ÊâãË®ò‰∫ãÊú¨ A URL</label>
                                    <input type="text" id="key-note-doc-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-emerald-500 outline-none" placeholder="Apps Script URL (Notebook A)">
                                </div>
                                <div>
                                    <label class="block text-xs text-teal-300 mb-1 font-bold"><i class="ph-fill ph-notebook"></i> Èö®ÊâãË®ò‰∫ãÊú¨ B URL</label>
                                    <input type="text" id="key-note-doc-url-2" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-teal-500 outline-none" placeholder="Apps Script URL (Notebook B)">
                                </div>
                            </div>

                            <div class="border-t border-white/10 pt-2">
                                 <label class="block text-xs text-red-300 mb-1 font-bold"><i class="ph-fill ph-upload"></i> Google Drive ‰∏äÂÇ≥ URL (ÈåÑÈü≥Áî®)</label>
                                 <input type="text" id="key-drive-url" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-red-500 outline-none" placeholder="Apps Script URL (Drive Upload)">
                            </div>

                            <div class="flex items-center justify-between mt-2">
                                <span id="doc-monitor-status" class="text-[10px] text-slate-500">Êú™Ê∏¨Ë©¶</span>
                                <button onclick="testDocConnection()" class="text-[10px] bg-blue-600 px-3 py-1 rounded text-white hover:bg-blue-500 transition-colors">Ê∏¨Ë©¶ÈÄ£Á∑ö</button>
                            </div>
                        </div>
                        <div class="space-y-3 pt-2 pb-4 border-b border-slate-800">
                            <div><label class="block text-xs text-blue-400 mb-1">Gemini API Key</label><input type="password" id="key-gemini" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-blue-500 outline-none"></div>
                            <div><label class="block text-xs text-green-400 mb-1">SerpApi Key</label><input type="password" id="key-serpapi" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-green-500 outline-none" placeholder="Your SerpApi Key"></div>
                            <div><label class="block text-xs text-rose-400 mb-1">Groq API Key</label><input type="password" id="key-groq" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-rose-500 outline-none"></div>
                            <div><label class="block text-xs text-violet-400 mb-1">Cohere API Key</label><input type="password" id="key-cohere" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-violet-500 outline-none"></div>
                            <div><label class="block text-xs text-emerald-400 mb-1">OpenAI API Key</label><input type="password" id="key-openai" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-emerald-500 outline-none"></div>
                            <div><label class="block text-xs text-slate-300 mb-1">Grok API Key</label><input type="password" id="key-grok" class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-xs focus:border-slate-500 outline-none"></div>
                        </div>
                    </div>
                    <!-- Export / Import / Save controls in Footer -->
                    <div class="mt-4 pt-2 flex justify-between items-center shrink-0">
                        <div class="flex space-x-2">
                            <button onclick="exportSettings()" class="flex items-center gap-1 text-xs text-blue-400 bg-blue-900/30 border border-blue-500/30 px-3 py-2 rounded-lg hover:bg-blue-800/50 transition-colors"><i class="ph-bold ph-download-simple"></i> ÂåØÂá∫Ë®≠ÂÆö</button>
                            <button onclick="triggerImportSettings()" class="flex items-center gap-1 text-xs text-emerald-400 bg-emerald-900/30 border border-emerald-500/30 px-3 py-2 rounded-lg hover:bg-emerald-800/50 transition-colors"><i class="ph-bold ph-upload-simple"></i> ÂåØÂÖ•Ë®≠ÂÆö</button>
                            <input type="file" id="import-settings-input" accept=".json" class="hidden" onchange="importSettings(event)">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="closeSettings()" class="px-4 py-2 text-slate-400 text-sm">ÂèñÊ∂à</button>
                            <button onclick="saveKeys()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500">ÂÑ≤Â≠ò</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ALARM MODAL -->
            <div id="alarm-modal" class="hidden fixed inset-0 z-[60] bg-slate-950/90 backdrop-blur-md flex flex-col items-center justify-center p-6">
                <div class="bg-slate-900 border border-red-500/50 rounded-2xl p-8 max-w-sm w-full text-center shadow-[0_0_50px_rgba(239,68,68,0.3)] animate-pulse">
                    <i class="ph-fill ph-alarm text-6xl text-red-500 mb-4 inline-block animate-bounce"></i>
                    <h3 class="text-2xl font-bold text-white mb-2">ÊôÇÈñìÂà∞ÔºÅ</h3>
                    <p id="alarm-text" class="text-lg text-slate-300 mb-8">ÊèêÈÜí‰∫ãÈ†ÖÂÖßÂÆπ</p>
                    <button onclick="stopAlarm()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform active:scale-95">
                        <i class="ph-bold ph-check-circle mr-2"></i> Á¢∫ ÂÆö (ÂÅúÊ≠¢)
                    </button>
                </div>
            </div>

            <!-- SOS MODAL -->
            <div id="sos-modal" class="hidden fixed inset-0 z-[70] bg-red-950/95 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center">
                <i class="ph-fill ph-warning-circle text-7xl text-red-500 mb-4 animate-pulse"></i>
                <h2 id="sos-title" class="text-3xl font-bold text-white mb-2">Á∑äÊÄ•ÊïëÊè¥Ëß∏Áôº</h2>
                <p class="text-lg text-red-200 mb-2">Â∞áÊí•ÊâìÁï∂Âú∞Â∞àÁ∑ö: <span id="sos-number" class="font-bold text-3xl text-white tracking-widest"></span></p>
                <p class="text-sm text-slate-400 mb-8">‰∏¶ÁôºÈÄÅÂåÖÂê´Â∫ßÊ®ô‰πãÊ±ÇÊïëÁ∞°Ë®ä</p>
                <div class="text-9xl font-bold text-white mb-8" id="sos-countdown">10</div>
                
                <div class="w-full max-w-xs space-y-3">
                    <button onclick="setSOSDrillMode()" id="sos-drill-btn" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform active:scale-95">
                        <i class="ph-bold ph-shield-check mr-2"></i>ÂàáÊèõÁÇ∫ÊºîÁøíÊ®°Âºè
                    </button>
                    <button onclick="cancelSOS()" class="w-full bg-slate-800 border border-slate-600 hover:bg-slate-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform active:scale-95">
                        <i class="ph-bold ph-x mr-2"></i>ÂèñÊ∂à (Cancel)
                    </button>
                </div>
            </div>

            <div id="view-dashboard" class="flex flex-col lg:flex-row h-full w-full relative min-h-0">
                <div class="flex-1 flex flex-col h-full min-w-0 relative">
                    <div class="p-3 border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm flex justify-between items-center shrink-0 overflow-x-auto no-scrollbar">
                         <div class="flex items-center space-x-2 mr-4 shrink-0">
                            <span id="web-search-badge" class="hidden md:flex items-center space-x-1 text-[10px] bg-blue-900/30 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded-full"><i class="ph-bold ph-globe"></i><span>ÈÄ£Á∂≤ÊêúÂ∞ã</span></span>
                            <!-- Recording Indicator -->
                            <div id="recording-status" class="hidden items-center space-x-2 bg-red-900/50 border border-red-500/50 px-3 py-1 rounded-full animate-pulse mr-2">
                                <div class="w-2 h-2 bg-red-500 rounded-full recording-dot"></div>
                                <span class="text-xs text-red-200 font-bold">ÈåÑÈü≥‰∏≠...</span>
                            </div>
                            <span id="doc-monitor-badge" class="hidden items-center space-x-1 text-[10px] bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 px-2 py-0.5 rounded-full animate-pulse"><i class="ph-bold ph-arrows-clockwise"></i><span>Docs Áõ£Êéß‰∏≠</span></span>
                            <button onclick="clearChatHistory()" class="text-[10px] text-slate-500 hover:text-red-400 flex items-center space-x-1 border border-slate-700 px-2 py-0.5 rounded-lg transition-colors"><i class="ph-bold ph-trash"></i><span>Ê∏ÖÁ©∫Â∞çË©±</span></button>
                         </div>
                         
                         <!-- Dropdown Model Selection -->
                         <div class="flex space-x-1 ml-auto shrink-0">
                             <select id="main-model-select" onchange="setModel(this.value)" class="bg-slate-800 border border-slate-600 text-white text-xs rounded-lg px-3 py-1 outline-none focus:border-blue-500 font-bold tracking-wide">
                                 <option value="gemini">Gemini</option>
                                 <option value="grok">Grok</option>
                                 <option value="groq">Groq</option>
                                 <option value="cohere">Cohere</option>
                                 <option value="gpt">OpenAI</option>
                             </select>
                         </div>
                    </div>
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-thin scrollbar-thumb-slate-700"></div>
                    <div class="p-4 bg-slate-900 border-t border-slate-800 shrink-0 z-20 pb-[calc(1rem+env(safe-area-inset-bottom))]">
                        <div id="input-wrapper" class="flex items-center bg-slate-950 rounded-xl px-2 py-2 border border-slate-700 focus-within:border-blue-500 transition-colors">
                            <button id="continuous-btn" onclick="toggleContinuous()" class="p-3 rounded-lg text-slate-500 hover:text-emerald-400 hover:bg-slate-800 transition-all flex-shrink-0 mr-1" title="ÈÄ£Á∫åË™ûÈü≥Â∞çË©± (6ÁßíËá™ÂãïÁôºÈÄÅ)"><i id="continuous-icon" class="ph-bold ph-infinity text-xl"></i></button>
                            <button id="search-toggle-btn" onclick="toggleSearch()" class="p-3 rounded-lg text-slate-500 hover:text-blue-400 hover:bg-slate-800 transition-all flex-shrink-0 mr-1" title="ÂàáÊèõÊêúÂ∞ã (Gemini Only)"><i id="search-icon" class="ph-bold ph-globe text-xl"></i></button>
                            <button id="voice-btn" onclick="toggleVoice()" class="p-3 mr-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all active:scale-95 flex-shrink-0"><i id="voice-icon" class="ph-bold ph-microphone text-xl"></i></button>
                            <input type="text" id="user-input" placeholder="Â∞çË©±„ÄÅËº∏ÂÖ•„ÄåÊêúÂ∞ã(ÂÖßÂÆπ)„ÄçÊàñ„ÄåÊí•Êâì(ËôüÁ¢º)„Äç..." class="flex-1 bg-transparent border-none focus:ring-0 text-white outline-none h-full" onkeydown="handleEnter(event)">
                            <button onclick="handleSendMessage()" id="send-btn" class="ml-2 p-3 rounded-lg text-white bg-blue-600 hover:opacity-90 flex-shrink-0 transition-all"><i id="send-icon" class="ph-bold ph-paper-plane-right"></i></button>
                        </div>
                        <div id="search-hint" class="text-[10px] text-blue-400 mt-2 text-center hidden">üåê Â∑≤ÈñãÂïüÈÄ£Á∂≤ÊêúÂ∞ã (Gemini)</div>
                    </div>
                </div>
                
                <!-- Right Sidebar -->
                <div class="hidden lg:flex w-80 bg-slate-900 flex-col p-6 space-y-6 border-l border-slate-800 overflow-y-auto shrink-0">
                    <div class="bg-gradient-to-br from-indigo-900 to-slate-800 rounded-3xl p-6 text-white shadow-lg border border-slate-700 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div><h3 class="text-slate-300 text-xs font-bold uppercase mb-1">ÁõÆÂâçÂ§©Ê∞£</h3><div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="cycleManualLocation()"><i class="ph-fill ph-map-pin text-blue-400"></i><span id="location-name" class="text-lg font-bold text-white border-b border-dashed border-slate-500">Êú™ÂÆö‰Ωç</span></div></div><i id="weather-icon" class="ph-fill ph-cloud-sun text-4xl text-yellow-400"></i>
                            </div>
                            <div class="mt-4 flex items-end space-x-2"><span id="weather-temp" class="text-5xl font-bold">--¬∞</span><span id="weather-desc" class="text-slate-300 text-sm mb-2">--</span></div>
                        </div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-calendar-check text-blue-500"></i>ËøëÊúü‰ªªÂãô</h3><button onclick="switchTab('schedule')" class="text-xs text-blue-400">ÁÆ°ÁêÜ</button></div>
                        <div id="mini-todo-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-slate-950 rounded-2xl p-5 border border-slate-800">
                         <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-500"></i>ÊúÄÊñ∞Á≠ÜË®ò</h3><button onclick="switchTab('notes')" class="text-xs text-blue-400">Êü•Áúã</button></div>
                        <div id="mini-note-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Other Views -->
            <div id="view-schedule" class="hidden flex-col h-full w-full p-6 overflow-y-auto"><div class="max-w-3xl mx-auto w-full"><header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Ë°åÁ®ãÁÆ°ÁêÜ</h2><button onclick="addTodoManually()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>Êñ∞Â¢û</span></button></header><div id="full-todo-list" class="space-y-3"></div></div></div>
            
            <!-- Notes View -->
            <div id="view-notes" class="hidden flex-col h-full w-full p-6 overflow-y-auto">
                <div class="max-w-5xl mx-auto w-full">
                    <!-- Google Docs Writer Widget -->
                    <div class="bg-gradient-to-r from-blue-900/40 to-slate-900 border border-blue-500/30 rounded-2xl p-6 mb-8 relative overflow-hidden shadow-lg">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="ph-fill ph-notebook text-emerald-400"></i> Èö®ÊâãË®ò‰∫ãÊú¨</h3>
                                <div class="flex gap-2">
                                    <button onclick="openNoteDocViewer()" class="text-xs bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded-lg border border-slate-600 flex items-center gap-2 transition-colors"><i class="ph-bold ph-book-open"></i> Èñ±ËÆÄ</button>
                                </div>
                            </div>
                            
                            <!-- Notebook Switcher -->
                            <div class="flex space-x-2 mb-4 bg-slate-950/50 p-1 rounded-lg inline-flex">
                                <button onclick="setActiveNotebook(1)" id="btn-nb-1" class="flex-1 text-xs px-4 py-1.5 rounded-md font-bold transition-all bg-emerald-600 text-white">Á≠ÜË®òÊú¨ A</button>
                                <button onclick="setActiveNotebook(2)" id="btn-nb-2" class="flex-1 text-xs px-4 py-1.5 rounded-md font-bold transition-all text-slate-400 hover:text-white">Á≠ÜË®òÊú¨ B</button>
                            </div>
                            
                            <!-- Tabs -->
                            <div class="flex space-x-2 mb-3">
                                <button onclick="setWriteMode('text')" id="btn-mode-text" class="text-xs px-3 py-1 rounded-full bg-blue-600 text-white font-bold transition-all">Á¥îÊñáÂ≠ó / Ë≤º‰∏äÂúñÁâá (Ctrl+V)</button>
                                <button onclick="setWriteMode('image')" id="btn-mode-image" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all">ÂúñÁâáÁ∂≤ÂùÄ</button>
                                <button onclick="setWriteMode('link')" id="btn-mode-link" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all">Ë∂ÖÈÄ£Áµê</button>
                            </div>

                            <div class="flex flex-col gap-3">
                                <!-- Inputs -->
                                <div class="relative">
                                    <textarea id="doc-input-main" rows="5" placeholder="Ëº∏ÂÖ•ÊñáÂ≠óÂÖßÂÆπÔºåÊàñÁõ¥Êé• Ctrl+V Ë≤º‰∏äÂúñÁâá..." class="w-full bg-slate-950/80 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none pr-24 resize-none" onkeydown="handleNoteKeydown(event)"></textarea>
                                    <div id="paste-indicator" class="hidden absolute right-3 top-3 text-[10px] text-emerald-400 bg-emerald-900/50 px-2 py-0.5 rounded border border-emerald-500/50 animate-pulse">
                                        <i class="ph-bold ph-image"></i> ÂúñÁâáÂ∑≤Â∞±Á∑í
                                    </div>
                                    <button onclick="clearNoteInput()" class="absolute right-3 bottom-3 text-slate-500 hover:text-red-400 p-1 bg-slate-900/50 rounded-full transition-colors" title="Ê∏ÖÈô§ÂÖßÂÆπ"><i class="ph-bold ph-trash"></i></button>
                                    
                                    <button onclick="triggerPhotoUpload()" class="absolute right-28 bottom-3 text-slate-500 hover:text-white p-1 bg-slate-900/50 rounded-full transition-colors" title="ÈÅ∏ÊìáÂúñÁâá (Ë≥áÊñôÂ§æ)"><i class="ph-bold ph-image text-xl"></i></button>
                                    <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhotoSelect(event)">

                                    <button onclick="triggerCameraUpload()" class="absolute right-20 bottom-3 text-slate-500 hover:text-white p-1 bg-slate-900/50 rounded-full transition-colors" title="ÊãçÁÖß‰∏äÂÇ≥"><i class="ph-bold ph-camera text-xl"></i></button>
                                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoSelect(event)">

                                    <button onclick="toggleNoteVoice()" id="note-voice-btn" class="absolute right-10 bottom-3 text-slate-500 hover:text-white p-1 bg-slate-900/50 rounded-full transition-colors" title="Ë™ûÈü≥Ëº∏ÂÖ•"><i id="note-voice-icon" class="ph-bold ph-microphone text-xl"></i></button>
                                </div>
                                <input type="text" id="doc-input-sub" placeholder="Ëº∏ÂÖ•ÈÄ£ÁµêÁ∂≤ÂùÄ (‰æãÂ¶Ç: https://...)" class="hidden w-full bg-slate-950/80 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none">
                                
                                <div class="flex justify-end">
                                    <button onclick="handleDocWriteBtn()" id="note-send-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                        <i class="ph-bold ph-paper-plane-right"></i> ÁôºÈÄÅÂØ´ÂÖ•
                                    </button>
                                </div>
                            </div>
                            <p id="active-notebook-label" class="text-[10px] text-slate-400 mt-2 opacity-80">* ÁõÆÂâçÂØ´ÂÖ•ÁõÆÊ®ôÔºöÁ≠ÜË®òÊú¨ A</p>
                        </div>
                    </div>

                    <header class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Êú¨Âú∞Á≠ÜË®ò‰∏≠ÂøÉ</h2><button onclick="addNoteManually()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2"><i class="ph-bold ph-plus"></i><span>Êñ∞Â¢û</span></button></header>
                    <div id="full-note-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
            
            <!-- Full Doc Viewer Modal -->
            <div id="doc-viewer-modal" class="hidden fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex flex-col p-4">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="ph-fill ph-book-open text-blue-400"></i> Êñá‰ª∂ÁÄèË¶ΩÂô®</h3>
                    <div class="flex gap-2">
                        <button onclick="refreshNoteDocView()" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 text-xs"><i class="ph-bold ph-arrows-clockwise"></i> ÈáçÊñ∞Êï¥ÁêÜ</button>
                        <button onclick="closeDocViewer()" class="p-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700"><i class="ph-bold ph-x text-lg"></i></button>
                    </div>
                </div>
                <div class="flex-1 bg-white text-slate-900 rounded-xl p-6 overflow-y-auto shadow-2xl font-serif leading-relaxed text-lg" id="doc-content-area">
                    <div class="flex items-center justify-center h-full text-slate-400 gap-2"><div class="dot-flashing bg-slate-400"></div> ËºâÂÖ•‰∏≠...</div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global variables
        let recognition = null;
        let noteRecognition = null;
        let voiceTimer = null;
        let initialInput = "";
        
        let alarmInterval = null;
        let alarmAudioCtx = null;
        let mediaRecorder = null;
        let audioChunks = [];

        const appState = {
            currentModel: 'gemini', 
            docMonitorUrl: localStorage.getItem('nova_doc_url') || '',
            noteDocUrl: localStorage.getItem('nova_note_doc_url') || '', 
            noteDocUrl2: localStorage.getItem('nova_note_doc_url_2') || '',
            activeNotebook: 1,
            driveUrl: localStorage.getItem('nova_drive_url') || '',
            
            messages: JSON.parse(localStorage.getItem('nova_messages') || '[]'),
            todos: JSON.parse(localStorage.getItem('nova_todos') || '[]'),
            notes: JSON.parse(localStorage.getItem('nova_notes') || '[]'),
            weather: { temp: '--', condition: 'cloudy', humidity: '--', wind: '--', loc: 'Êú™ÂÆö‰Ωç' },
            keys: { 
                gemini: localStorage.getItem('nova_key_gemini')||'', 
                groq: localStorage.getItem('nova_key_groq')||'',
                cohere: localStorage.getItem('nova_key_cohere')||'',
                openai: localStorage.getItem('nova_key_openai')||'', 
                grok: localStorage.getItem('nova_key_grok')||'',
                serpapi: localStorage.getItem('nova_key_serpapi')||''
            },
            isThinking: false, isListening: false, isNoteListening: false, isSearchEnabled: false,
            isContinuous: false,
            manualLocIndex: 0,
            manualLocs: [{name: "Âè∞Âåó", lat: 25.0330, lon: 121.5654}, {name: "Âè∞‰∏≠", lat: 24.1477, lon: 120.6736}, {name: "È´òÈõÑ", lat: 22.6273, lon: 120.3014}],
            pendingReminder: null,
            reminderStage: 0,
            countryCode: 'TW',
            lastLat: null,
            lastLon: null,
            sosTimer: null,
            sosCount: 10,
            isSOSDrill: false 
        };
        
        const MODEL_CONFIG = {
            gemini: { name: 'Gemini (2.5 Flash)', color: 'text-blue-400', bg: 'bg-blue-600', icon: 'ph-globe' },
            grok: { name: 'Grok (4.1 Fast)', color: 'text-slate-100', bg: 'bg-slate-600', icon: 'ph-lightning' },
            groq: { name: 'Groq', color: 'text-rose-400', bg: 'bg-rose-600', icon: 'ph-rocket' },
            cohere: { name: 'Cohere', color: 'text-violet-400', bg: 'bg-violet-600', icon: 'ph-cpu' },
            gpt: { name: 'OpenAI', color: 'text-emerald-400', bg: 'bg-emerald-600', icon: 'ph-cpu' }
        };

        // --- UTILS ---
        function saveMessages() { localStorage.setItem('nova_messages', JSON.stringify(appState.messages)); }
        function saveData() { localStorage.setItem('nova_todos', JSON.stringify(appState.todos)); localStorage.setItem('nova_notes', JSON.stringify(appState.notes)); }
        function getTime() { return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        
        function formatMessage(text) { 
            if (!text) return ''; 
            let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
            safe = safe.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-bold">$1</strong>'); 
            
            safe = safe.replace(/\[([^\]]+)\]\((https?:\/\/[^\s<]+?)\)|(https?:\/\/[^\s<)\]]+)/g, function(match, mdTitle, mdUrl, rawUrl) {
                if (mdUrl) {
                    return `<a href="${mdUrl}" target="_blank" class="text-blue-400 underline break-all">${mdTitle}</a>`;
                } else if (rawUrl) {
                    return `<a href="${rawUrl}" target="_blank" class="text-blue-400 underline break-all">${rawUrl}</a>`;
                }
                return match;
            });
            
            return safe.replace(/\n/g, '<br>'); 
        }
        
        function escapeHtml(t){return t?t.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">"):""}

        // --- RENDERERS ---
        function renderAll() { renderMessages(); renderTodos(); renderNotes(); renderWeather(); }
        function renderMessages() { 
            const container = document.getElementById('chat-container');
            if(!container) return;
            container.innerHTML = appState.messages.map(msg => { 
                const isUser = msg.sender === 'user'; 
                const modelInfo = isUser ? null : MODEL_CONFIG[msg.model]; 
                let sourcesHTML = ''; 
                if (msg.sources?.length) sourcesHTML = `<div class="mt-3 pt-3 border-t border-slate-700/50"><p class="text-[10px] text-slate-400 mb-1 font-bold">‰æÜÊ∫êÔºö</p><div class="flex flex-wrap gap-2">${msg.sources.map((s,i)=>`<a href="${s.uri}" target="_blank" class="text-[10px] bg-slate-950/50 text-blue-400 px-2 py-1 rounded border border-slate-700/50 block truncate max-w-[150px]">${i+1}. ${s.title}</a>`).join('')}</div></div>`; 
                return `<div class="group flex ${isUser ? 'justify-end' : 'justify-start items-start space-x-3'} fade-in relative mb-4">
                    ${!isUser ? `<div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1 ${modelInfo?.bg||'bg-slate-700'}"><i class="ph-fill ${modelInfo?.icon||'ph-robot'} text-white text-sm"></i></div>` : ''}
                    <div class="msg-group relative max-w-[90%] md:max-w-[80%] rounded-2xl p-4 shadow-sm ${isUser ? 'bg-slate-800 text-white rounded-br-none' : 'bg-slate-900 border border-slate-800 text-slate-200 rounded-tl-none'}">
                        ${!isUser ? `<span class="text-[10px] font-bold uppercase mb-1 block ${modelInfo?.color||'text-slate-400'} opacity-80">${modelInfo?.name||'System'}</span>` : ''}
                        <div class="msg-content text-sm leading-relaxed">${formatMessage(msg.text)}</div>
                        ${sourcesHTML}
                        <p class="text-[10px] mt-2 text-right text-slate-500 opacity-60">${msg.time}</p>
                        <button onclick="deleteMessage(${msg.id})" class="msg-actions absolute top-2 right-2 p-1 text-slate-500 hover:text-red-400 transition-colors bg-slate-950/50 rounded-full"><i class="ph-bold ph-trash text-xs"></i></button>
                    </div>
                </div>`; 
            }).join(''); 
            container.scrollTop = container.scrollHeight; 
        }

        function renderThinkingState(show) { 
            const el = document.getElementById('thinking-indicator'); 
            const container = document.getElementById('chat-container');
            if(show && !el && container) container.insertAdjacentHTML('beforeend', `<div id="thinking-indicator" class="flex justify-start items-center space-x-3 fade-in"><div class="w-8 h-8 rounded-full flex items-center justify-center ${MODEL_CONFIG[appState.currentModel]?.bg || 'bg-slate-700'}"><i class="ph-fill ${MODEL_CONFIG[appState.currentModel]?.icon || 'ph-robot'} text-white text-sm"></i></div><div class="bg-slate-900 border border-slate-800 p-4 rounded-2xl rounded-tl-none"><div class="dot-flashing ml-2"></div></div></div>`); 
            else if(!show && el) el.remove(); 
        }

        function renderTodos() { 
            const el = document.getElementById('full-todo-list');
            if(!el) return;
            el.innerHTML=appState.todos.map(t=>`<div class="group bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between hover:border-slate-600 transition-all slide-in"><div class="flex items-center space-x-4"><button onclick="toggleTodo(${t.id})" class="text-slate-500 hover:text-blue-400"><i class="ph${t.done?'-fill ph-check-circle text-green-500':' ph-circle'} text-2xl"></i></button><div><p class="text-base ${t.done?'line-through text-slate-600':'text-slate-200'}">${escapeHtml(t.text)}</p><span class="text-xs text-slate-500">${t.time}</span></div></div><button onclick="deleteTodo(${t.id})" class="text-slate-500 hover:text-red-400 p-2"><i class="ph ph-trash"></i></button></div>`).join('')||'<p class="text-slate-500 text-center mt-10">ÁÑ°‰ªªÂãô</p>'; 
            const mini = document.getElementById('mini-todo-list');
            if(mini) mini.innerHTML=appState.todos.slice(0,3).map(t=>`<div class="flex items-center space-x-3 p-2 bg-slate-950/50 rounded-lg border border-slate-800/50"><div class="w-1.5 h-8 rounded-full ${t.done?'bg-green-500':'bg-blue-500'}"></div><div class="flex-1 min-w-0"><p class="text-xs truncate ${t.done?'line-through text-slate-600':'text-slate-300'}">${escapeHtml(t.text)}</p></div></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ÁÑ°ÂæÖËæ¶</p>'; 
        }

        function renderNotes() { 
            const el = document.getElementById('full-note-list');
            if(!el) return;
            el.innerHTML=appState.notes.map(n=>`<div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 hover:border-slate-600 flex flex-col h-48 relative overflow-hidden slide-in"><div class="flex justify-between mb-2"><h3 class="text-lg font-bold text-white truncate pr-2">${escapeHtml(n.title)}</h3><span class="text-xs text-slate-500 whitespace-nowrap">${n.date}</span></div><p class="text-slate-300 text-sm overflow-y-auto flex-1 scrollbar-thin">${escapeHtml(n.content)}</p><button onclick="deleteNote(${n.id})" class="absolute bottom-4 right-4 text-slate-600 hover:text-red-400"><i class="ph ph-trash text-lg"></i></button></div>`).join('')||'<p class="text-slate-500 text-center col-span-3 mt-10">ÁÑ°Á≠ÜË®ò</p>'; 
            const mini = document.getElementById('mini-note-list');
            if(mini) mini.innerHTML=appState.notes.slice(0,2).map(n=>`<div class="bg-slate-950/50 p-3 rounded-lg border border-slate-800/50 cursor-pointer hover:border-slate-700" onclick="switchTab('notes')"><h4 class="text-slate-300 text-xs font-bold mb-1 truncate">${escapeHtml(n.title)}</h4><p class="text-slate-500 text-[10px] line-clamp-1">${escapeHtml(n.content)}</p></div>`).join('')||'<p class="text-xs text-slate-500 text-center">ÁÑ°Á≠ÜË®ò</p>'; 
        }

        function renderWeather() { 
            const {temp,condition,humidity,wind,loc}=appState.weather; 
            let icon='ph-cloud',color='text-slate-400',desc='Â§öÈõ≤'; 
            if(condition==='sunny'){icon='ph-sun';color='text-yellow-400';desc='Êô¥Êúó';} 
            if(condition==='rainy'){icon='ph-cloud-rain';color='text-blue-400';desc='ÊúâÈõ®';} 
            
            const locEl = document.getElementById('location-name'); 
            if(locEl) locEl.innerText=loc; 
            
            const tempEl = document.getElementById('weather-temp'); 
            if(tempEl) tempEl.innerText=`${temp}¬∞`; 
            
            const descEl = document.getElementById('weather-desc'); 
            if(descEl) descEl.innerText=desc; 
            
            const iconEl = document.getElementById('weather-icon'); 
            if(iconEl) iconEl.className=`ph-fill ${icon} text-4xl ${color}`; 
            
            const mTemp = document.getElementById('mobile-weather-temp'); 
            if(mTemp) mTemp.innerText=loc==='Êú™ÂÆö‰Ωç'?'ÂÆö‰Ωç':`${temp}¬∞`; 
            
            const mIcon = document.getElementById('mobile-weather-icon'); 
            if(mIcon) mIcon.className=`ph-fill ${loc==='Êú™ÂÆö‰Ωç'?'ph-navigation-arrow':icon} ${color}`; 
        }

        function updateModelUI(){ 
            const conf=MODEL_CONFIG[appState.currentModel]; 
            const statusName = document.getElementById('status-name'); if(statusName) statusName.innerText=conf?.name || 'Unknown'; 
            const statusIcon = document.getElementById('status-icon'); if(statusIcon) statusIcon.className=`ph-fill ${conf?.icon || 'ph-cpu'} text-lg ${conf?.color || 'text-slate-400'}`; 
            
            const selectEl = document.getElementById('main-model-select');
            if(selectEl) selectEl.value = appState.currentModel;
            
            const wrap = document.getElementById('input-wrapper'); if(wrap) wrap.className = `flex items-center bg-slate-950 rounded-xl px-2 py-2 border transition-colors border-slate-700 focus-within:border-${appState.currentModel==='gemini'?'blue':appState.currentModel==='groq'?'rose':appState.currentModel==='cohere'?'violet':appState.currentModel==='gpt'?'emerald':'slate'}-500`; 
            
            const badge=document.getElementById('web-search-badge'); const searchBtn=document.getElementById('search-toggle-btn'); const hint=document.getElementById('search-hint'); 
            if(searchBtn) {
                if(appState.isSearchEnabled){ searchBtn.classList.add('text-blue-400','bg-blue-900/30'); searchBtn.classList.remove('text-slate-500'); if(badge)badge.classList.remove('hidden'); if(hint)hint.classList.remove('hidden'); }
                else{ searchBtn.classList.remove('text-blue-400','bg-blue-900/30'); searchBtn.classList.add('text-slate-500'); if(badge)badge.classList.add('hidden'); if(hint)hint.classList.add('hidden'); }
            }
            if(appState.currentModel!=='gemini'&&appState.isSearchEnabled){setModel('gemini');} 
        }

        // --- ACTIONS ---
        function addMessage(text, sender, model, sources=[]) { appState.messages.push({id:Date.now(), text, sender, model, sources, time:getTime()}); saveMessages(); renderMessages(); }
        function deleteMessage(id) { appState.messages = appState.messages.filter(m => m.id !== id); saveMessages(); renderMessages(); }
        function clearChatHistory() { if(confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ∞çË©±Á¥ÄÈåÑÂóéÔºü")) { appState.messages = []; saveMessages(); renderMessages(); } }
        function toggleTodo(id){ const t=appState.todos.find(x=>x.id===id); if(t){t.done=!t.done;saveData();renderTodos();} }
        function deleteTodo(id){ appState.todos=appState.todos.filter(x=>x.id!==id); saveData(); renderTodos(); }
        function deleteNote(id){ appState.notes=appState.notes.filter(x=>x.id!==id); saveData(); renderNotes(); }
        function addTodoManually(){ const t=prompt("‰ªªÂãô"); if(t){appState.todos.push({id:Date.now(),text:t,done:false,time:'ÊâãÂãï'});saveData();renderTodos();} }
        function addNoteManually(){ const t=prompt("Ê®ôÈ°å"),c=prompt("ÂÖßÂÆπ"); if(t&&c){appState.notes.push({id:Date.now(),title:t,content:c,date:new Date().toLocaleDateString()});saveData();renderNotes();} }
        function switchTab(id){ ['dashboard','schedule','notes'].forEach(t=>document.getElementById(`view-${t}`).classList.add('hidden')); document.getElementById(`view-${id}`).classList.remove('hidden'); document.getElementById(`view-${id}`).classList.add('flex'); document.querySelectorAll('.nav-item').forEach(b=>{b.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl text-slate-400 hover:bg-slate-800 transition-all';}); const active=document.getElementById(`nav-${id}`); if(active)active.className='nav-item flex items-center space-x-3 w-full p-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg transition-all'; }
        function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');}
        function closeSettings(){document.getElementById('settings-modal').classList.add('hidden');}
        
        function saveKeys(){ 
            const safeGetVal = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
            
            appState.keys.gemini = safeGetVal('key-gemini'); 
            appState.keys.groq = safeGetVal('key-groq');
            appState.keys.cohere = safeGetVal('key-cohere');
            appState.keys.openai = safeGetVal('key-openai'); 
            appState.keys.grok = safeGetVal('key-grok'); 
            appState.keys.serpapi = safeGetVal('key-serpapi'); 
            appState.docMonitorUrl = safeGetVal('key-doc-url'); 
            appState.noteDocUrl = safeGetVal('key-note-doc-url'); 
            appState.noteDocUrl2 = safeGetVal('key-note-doc-url-2'); 
            appState.driveUrl = safeGetVal('key-drive-url'); 
            
            localStorage.setItem('nova_key_gemini', appState.keys.gemini); 
            localStorage.setItem('nova_key_groq', appState.keys.groq); 
            localStorage.setItem('nova_key_cohere', appState.keys.cohere); 
            localStorage.setItem('nova_key_openai', appState.keys.openai); 
            localStorage.setItem('nova_key_grok', appState.keys.grok); 
            localStorage.setItem('nova_key_serpapi', appState.keys.serpapi); 
            localStorage.setItem('nova_doc_url', appState.docMonitorUrl); 
            localStorage.setItem('nova_note_doc_url', appState.noteDocUrl); 
            localStorage.setItem('nova_note_doc_url_2', appState.noteDocUrl2); 
            localStorage.setItem('nova_drive_url', appState.driveUrl); 
            
            updateModelUI(); 
            closeSettings(); 
            addMessage("‚úÖ Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò", 'system'); 
        }

        // --- EXPORT / IMPORT SETTINGS ---
        function exportSettings() {
            const data = {
                keys: appState.keys,
                urls: {
                    docMonitorUrl: appState.docMonitorUrl,
                    noteDocUrl: appState.noteDocUrl,
                    noteDocUrl2: appState.noteDocUrl2,
                    driveUrl: appState.driveUrl
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NOVA16_Settings_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function triggerImportSettings() {
            document.getElementById('import-settings-input').click();
        }

        function importSettings(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    if (data.keys) {
                        appState.keys.gemini = data.keys.gemini || '';
                        appState.keys.groq = data.keys.groq || '';
                        appState.keys.cohere = data.keys.cohere || '';
                        appState.keys.openai = data.keys.openai || '';
                        appState.keys.grok = data.keys.grok || '';
                        appState.keys.serpapi = data.keys.serpapi || '';
                    }
                    if (data.urls) {
                        appState.docMonitorUrl = data.urls.docMonitorUrl || '';
                        appState.noteDocUrl = data.urls.noteDocUrl || '';
                        appState.noteDocUrl2 = data.urls.noteDocUrl2 || '';
                        appState.driveUrl = data.urls.driveUrl || '';
                    }
                    
                    const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                    safeSet('key-gemini', appState.keys.gemini);
                    safeSet('key-groq', appState.keys.groq);
                    safeSet('key-cohere', appState.keys.cohere);
                    safeSet('key-openai', appState.keys.openai);
                    safeSet('key-grok', appState.keys.grok);
                    safeSet('key-serpapi', appState.keys.serpapi);
                    safeSet('key-doc-url', appState.docMonitorUrl);
                    safeSet('key-note-doc-url', appState.noteDocUrl);
                    safeSet('key-note-doc-url-2', appState.noteDocUrl2);
                    safeSet('key-drive-url', appState.driveUrl);
                    
                    alert("Ë®≠ÂÆöÂåØÂÖ•ÊàêÂäüÔºÅË´ãÈªûÊìäÂè≥‰∏ãËßí„ÄåÂÑ≤Â≠ò„ÄçÊåâÈàï‰æÜÂ•óÁî®Ë®≠ÂÆö„ÄÇ");
                } catch(err) {
                    alert("Ë®≠ÂÆöÊ™îËß£ÊûêÂ§±ÊïóÔºö" + err.message);
                }
                e.target.value = ''; 
            };
            reader.readAsText(file);
        }

        function setModel(m){ appState.currentModel=m; updateModelUI(); }
        function toggleMobileMenu(){document.getElementById('mobile-menu').classList.toggle('hidden');}
        function updateSendButtonState(isLoading) { const btn=document.getElementById('send-btn'),icon=document.getElementById('send-icon'); if(isLoading){btn.classList.add('cursor-not-allowed','opacity-70');icon.classList.remove('ph-paper-plane-right');icon.classList.add('ph-spinner','animate-spin');}else{btn.classList.remove('cursor-not-allowed','opacity-70');icon.classList.remove('ph-spinner','animate-spin');icon.classList.add('ph-paper-plane-right');} }
        function toggleSearch() { appState.isSearchEnabled = !appState.isSearchEnabled; updateModelUI(); }
        function cycleManualLocation() { appState.manualLocIndex = (appState.manualLocIndex + 1) % appState.manualLocs.length; const loc = appState.manualLocs[appState.manualLocIndex]; fetchWeather(loc.lat, loc.lon, loc.name + " (ÊâãÂãï)", false); }
        function handleEnter(e) { if(e.key==='Enter') handleSendMessage(); }
        
        // --- FIXED GPS LOCATION ---
        async function tryGetLocation(silent=false) { 
            if(!silent) updateLocStatus("GPSÂÆö‰Ωç‰∏≠..."); 
            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        appState.lastLat = p.coords.latitude;
                        appState.lastLon = p.coords.longitude;
                        // ‰ΩøÁî® BigDataCloud API ËºÉÁ©©ÂÆö‰∏îÁÑ°Âö¥Ê†ºË∑®ÂüüÊàñÈ†ªÁéáÈôêÂà∂
                        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&localityLanguage=zh-tw`)
                            .then(r=>r.json())
                            .then(d => { 
                                if(d.countryCode) appState.countryCode = d.countryCode.toUpperCase(); 
                                const city = d.city || d.locality || d.principalSubdivision || "ÁõÆÂâç‰ΩçÁΩÆ";
                                fetchWeather(p.coords.latitude, p.coords.longitude, city, silent);
                            })
                            .catch(() => { fetchWeather(p.coords.latitude, p.coords.longitude, "GPSÂÆö‰Ωç", silent); });
                    }, 
                    (e) => getIPLocation(silent), 
                    { timeout: 5000, enableHighAccuracy: true } 
                ); 
            } else getIPLocation(silent); 
        }
        
        async function getIPLocation(silent) { 
            if(!silent) updateLocStatus("IPÂÆö‰Ωç‰∏≠..."); 
            try { 
                const res = await fetch('https://ipapi.co/json/'); 
                if(!res.ok) throw new Error(); 
                const data=await res.json(); 
                appState.lastLat = data.latitude;
                appState.lastLon = data.longitude;
                if (data.country_code) appState.countryCode = data.country_code;
                fetchWeather(data.latitude, data.longitude, `${data.city}(IP)`, silent); 
            } catch(e){ 
                try { 
                    const res2 = await fetch('https://ipwho.is/'); 
                    const data2 = await res2.json(); 
                    if(!data2.success) throw new Error(); 
                    appState.lastLat = data2.latitude;
                    appState.lastLon = data2.longitude;
                    if (data2.country_code) appState.countryCode = data2.country_code;
                    fetchWeather(data2.latitude, data2.longitude, `${data2.city}(IP)`, silent); 
                } catch(e2) { 
                    updateLocStatus("ÂÆö‰ΩçÂ§±Êïó"); 
                    if(!silent) addMessage("‚ö†Ô∏è ÂÆö‰ΩçÂ§±ÊïóÔºåÂ∑≤ÂàáÊèõËá≥È†êË®≠ÂüéÂ∏Ç", "system"); 
                    const def = appState.manualLocs[0]; 
                    appState.countryCode = 'TW';
                    fetchWeather(def.lat, def.lon, def.name + " (È†êË®≠)", true); 
                } 
            } 
        }
        
        async function fetchWeather(lat, lon, locName, silent) { try { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`; const res = await fetch(url); const data = await res.json(); if(data.current) { const c = data.current; appState.weather = { temp: Math.round(c.temperature_2m), humidity: c.relative_humidity_2m, wind: c.wind_speed_10m, condition: wmoToCondition(c.weather_code), loc: locName }; renderWeather(); updateLocStatus("Â∑≤Êõ¥Êñ∞"); if(!silent) addMessage(`‚úÖ Â§©Ê∞£Â∑≤Êõ¥Êñ∞: ${c.temperature_2m}¬∞C`, "system"); } } catch(e) { updateLocStatus("ÈåØË™§"); } }
        function updateLocStatus(msg) { 
            const el = document.getElementById('location-status'); 
            if(el) el.innerText = msg; 
            if(msg==="Â∑≤Êõ¥Êñ∞"||msg.includes("È†êË®≠")||msg.includes("ÊâãÂãï")) { 
                const {loc, temp} = appState.weather; 
                const locName = document.getElementById('location-name'); if(locName) locName.innerText = loc; 
                const mTemp = document.getElementById('mobile-weather-temp'); if(mTemp) mTemp.innerText = `${temp}¬∞`; 
            } 
        }
        function wmoToCondition(c) { if(c===0)return 'sunny'; if(c<=48)return 'cloudy'; if(c<=82)return 'rainy'; if(c<=77)return 'snow'; return 'storm'; }

        // --- GLOBAL ACTIONS ---
        function toggleVoice() { 
            if (!recognition) { alert("ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥"); return; }
            if (appState.isListening) {
                appState.isContinuous = false; 
                document.getElementById('continuous-btn').classList.remove('text-emerald-400', 'animate-pulse');
                document.getElementById('continuous-btn').classList.add('text-slate-500');
                document.getElementById('continuous-icon').classList.remove('animate-spin-slow'); 
                
                recognition.stop();
                if(voiceTimer) clearTimeout(voiceTimer);
            } else {
                const input = document.getElementById('user-input');
                initialInput = input.value; 
                recognition.start();
            }
        }
        
        function toggleContinuous() {
            appState.isContinuous = !appState.isContinuous;
            const btn = document.getElementById('continuous-btn');
            const icon = document.getElementById('continuous-icon');
            
            if (appState.isContinuous) {
                btn.classList.remove('text-slate-500');
                btn.classList.add('text-emerald-400', 'bg-emerald-900/30', 'animate-pulse');
                icon.classList.add('animate-spin-slow'); 
                addMessage("üîÑ Â∑≤ÈñãÂïüÈÄ£Á∫åÂ∞çË©±Ê®°ÂºèÔºöË™™ÂÆåË©±Âæå6ÁßíËá™ÂãïÁôºÈÄÅÔºåÈ∫•ÂÖãÈ¢®Â∞áÊåÅÁ∫åÈñãÂïü„ÄÇ", "system");
                
                if (!appState.isListening && recognition) {
                    initialInput = document.getElementById('user-input').value;
                    recognition.start();
                }
            } else {
                btn.classList.add('text-slate-500');
                btn.classList.remove('text-emerald-400', 'bg-emerald-900/30', 'animate-pulse');
                icon.classList.remove('animate-spin-slow');
                addMessage("‚èπÔ∏è Â∑≤ÈóúÈñâÈÄ£Á∫åÂ∞çË©±Ê®°Âºè„ÄÇ", "system");
                if (appState.isListening && recognition) {
                    recognition.stop();
                }
            }
        }

        function updateVoiceUI() { 
            const btn=document.getElementById('voice-btn'),icon=document.getElementById('voice-icon'); 
            if(appState.isListening){btn.classList.add('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone','ph-microphone-stage');}
            else{btn.classList.remove('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone-stage','ph-microphone');} 
        }
        function toggleNoteVoice() { 
            if (!noteRecognition) { alert("ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥"); return; }
            if (appState.isNoteListening) noteRecognition.stop(); 
            else noteRecognition.start(); 
        }
        function updateNoteVoiceUI() { 
            const btn=document.getElementById('note-voice-btn'),icon=document.getElementById('note-voice-icon'); 
            if(appState.isNoteListening){btn.classList.add('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone','ph-microphone-stage');}
            else{btn.classList.remove('text-red-500','animate-pulse-fast');icon.classList.replace('ph-microphone-stage','ph-microphone');} 
        }

        // --- NATIVE BRIDGE HELPER ---
        function executeNativeCall(number) {
            // Android Native Bridge Detection
            if (window.Android && typeof window.Android.makeCall === 'function') {
                window.Android.makeCall(number);
                return true;
            }
            // iOS WKWebView Bridge Detection
            else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.makeCall) {
                window.webkit.messageHandlers.makeCall.postMessage(number);
                return true;
            }
            return false;
        }

        // --- SOS & CALL LOGIC ---
        function getEmergencyNumber(country, type) {
            const rules = {
                'TW': { '110': '110', '119': '119' },
                'JP': { '110': '110', '119': '119' },
                'KR': { '110': '112', '119': '119' },
                'CN': { '110': '110', '119': '120' },
                'US': { '110': '911', '119': '911' },
                'CA': { '110': '911', '119': '911' },
                'GB': { '110': '999', '119': '999' },
                'AU': { '110': '000', '119': '000' }
            };
            if (rules[country] && rules[country][type]) return rules[country][type];
            return '112'; // Global Fallback
        }

        function setSOSDrillMode() {
            appState.isSOSDrill = true;
            const drillBtn = document.getElementById('sos-drill-btn');
            if (drillBtn) {
                drillBtn.className = "w-full bg-emerald-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform active:scale-95";
                drillBtn.innerHTML = '<i class="ph-bold ph-check-circle mr-2"></i>Â∑≤ÈñãÂïüÊºîÁøíÊ®°Âºè';
                drillBtn.disabled = true;
            }
            
            const titleEl = document.getElementById('sos-title');
            if (titleEl) {
                titleEl.innerText = "Á∑äÊÄ•ÊïëÊè¥ (ÊºîÁøíÊ®°Âºè)";
                titleEl.className = "text-3xl font-bold text-yellow-400 mb-2";
            }
            addMessage("üõ°Ô∏è Â∑≤ÈñãÂïü SOS ÊºîÁøíÊ®°ÂºèÔºöÂÄíÊï∏ÁµêÊùüÂæåÂÉÖÊúÉËº∏Âá∫Ê®°Êì¨ÁµêÊûúÔºå‰∏çÊúÉÁúüÊ≠£Ëß∏ÁôºÊí•ËôüÊàñÁôºÈÄÅÁ∞°Ë®ä„ÄÇ", 'system');
        }

        function triggerEmergency(type) {
            // Reset state
            appState.isSOSDrill = false;
            const drillBtn = document.getElementById('sos-drill-btn');
            if (drillBtn) {
                drillBtn.className = "w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform active:scale-95";
                drillBtn.innerHTML = '<i class="ph-bold ph-shield-check mr-2"></i>ÂàáÊèõÁÇ∫ÊºîÁøíÊ®°Âºè';
                drillBtn.disabled = false;
            }
            const titleEl = document.getElementById('sos-title');
            if(titleEl) {
                titleEl.innerText = "Á∑äÊÄ•ÊïëÊè¥Ëß∏Áôº";
                titleEl.className = "text-3xl font-bold text-white mb-2";
            }

            const country = appState.countryCode || 'TW';
            const targetNumber = getEmergencyNumber(country, type);

            document.getElementById('sos-number').innerText = targetNumber;
            document.getElementById('sos-modal').classList.remove('hidden');
            document.getElementById('sos-modal').classList.add('flex');
            
            appState.sosCount = 10;
            document.getElementById('sos-countdown').innerText = appState.sosCount;
            if(navigator.vibrate) navigator.vibrate([500, 200, 500]);

            appState.sosTimer = setInterval(() => {
                appState.sosCount--;
                document.getElementById('sos-countdown').innerText = appState.sosCount;
                if(navigator.vibrate) navigator.vibrate(200);
                
                if(appState.sosCount <= 0) {
                    clearInterval(appState.sosTimer);
                    executeSOS(targetNumber);
                }
            }, 1000);
        }

        function cancelSOS() {
            if(appState.sosTimer) clearInterval(appState.sosTimer);
            document.getElementById('sos-modal').classList.add('hidden');
            document.getElementById('sos-modal').classList.remove('flex');
            addMessage("üõë Â∑≤ÂèñÊ∂àÁ∑äÊÄ•ÂëºÂè´Êåá‰ª§", 'system');
        }

        function executeSOS(number) {
            document.getElementById('sos-modal').classList.add('hidden');
            document.getElementById('sos-modal').classList.remove('flex');
            
            const lat = appState.lastLat || '';
            const lon = appState.lastLon || '';
            const locStr = (lat && lon) ? ` https://maps.google.com/?q=${lat},${lon}` : '';
            const msg = `I need help now!${locStr}`;
            
            if (appState.isSOSDrill) {
                addMessage(`üõ°Ô∏è „ÄêÁ∑äÊÄ•Ê±ÇÊïëÊºîÁøíÂÆåÊàê„Äë\nËã•Âú®ÁúüÂØ¶ÊÉÖÊ≥Å‰∏ãÔºåÁ≥ªÁµ±Â∞áÊúÉÁÇ∫ÊÇ®ÂëºÂè´ APP Êí•ÊâìËá≥ ${number} ‰∏¶ÁôºÈÄÅÊ±ÇÊïëÁ∞°Ë®ä„ÄÇ\n\nüìú Á∞°Ë®äÊ®°Êì¨ÂÖßÂÆπÔºö\n${msg}`, 'system');
                return;
            }

            addMessage(`üö® Ê≠£Âú®ÁôºÈÄÅÊ±ÇÊïëÁ∞°Ë®ä‰∏¶ÂëºÂè´ÈõªË©± APP Ëá≥ ${number}...`, 'system');
            
            // Trigger SMS app
            window.open(`sms:${number}?body=${encodeURIComponent(msg)}`, '_self');
            
            // Try Native Bridge Call, fallback to tel:
            setTimeout(() => {
                if(!executeNativeCall(number)){
                    addMessage(`(Ë®ªÔºöÊú™ÂÅµÊ∏¨Âà∞ÂéüÁîü APP BridgeÔºåÂ∑≤Ëá™ÂãïÈôçÁ¥öÁÇ∫Á∂≤È†ÅÂëºÂè´„ÄÇÂèóÈôêÊñºÊâãÊ©üÂÆâÂÖ®Ê©üÂà∂ÔºåË´ãÊñºÁï´Èù¢ÊâãÂãïÊåâ‰∏ãÈÄöË©±ÈçµÁ¢∫Ë™ç)`, 'system');
                    window.open(`tel:${number}`, '_self');
                } else {
                    addMessage(`(‚úÖ Â∑≤ÈÄèÈÅéÂéüÁîü Bridge ÁôºÈÄÅÁõ¥Êé•Êí•ËôüÊåá‰ª§)`, 'system');
                }
            }, 2000);
        }

        // --- NOTEBOOK 2 LOGIC ---
        function setActiveNotebook(num) {
            appState.activeNotebook = num;
            const btn1 = document.getElementById('btn-nb-1');
            const btn2 = document.getElementById('btn-nb-2');
            const label = document.getElementById('active-notebook-label');
            
            if(num === 1) {
                btn1.classList.add('bg-emerald-600', 'text-white');
                btn1.classList.remove('text-slate-400', 'hover:text-white');
                btn2.classList.remove('bg-teal-600', 'text-white');
                btn2.classList.add('text-slate-400', 'hover:text-white');
                label.innerText = '* ÁõÆÂâçÂØ´ÂÖ•ÁõÆÊ®ôÔºöÁ≠ÜË®òÊú¨ A (URL 1)';
            } else {
                btn2.classList.add('bg-teal-600', 'text-white');
                btn2.classList.remove('text-slate-400', 'hover:text-white');
                btn1.classList.remove('bg-emerald-600', 'text-white');
                btn1.classList.add('text-slate-400', 'hover:text-white');
                label.innerText = '* ÁõÆÂâçÂØ´ÂÖ•ÁõÆÊ®ôÔºöÁ≠ÜË®òÊú¨ B (URL 2)';
            }
        }

        // --- PHOTO LOGIC ---
        function triggerPhotoUpload() { document.getElementById('photo-input').click(); }
        function triggerCameraUpload() { document.getElementById('camera-input').click(); }
        
        function handlePhotoSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                appState.pastedImageBase64 = evt.target.result;
                const indicator = document.getElementById('paste-indicator');
                if(indicator) indicator.classList.remove('hidden');
                const docInput = document.getElementById('doc-input-main');
                docInput.value = "[Â∑≤ÂÅµÊ∏¨Âà∞ÈÅ∏ÊìáÁöÑÂúñÁâáÔºåË´ãÈªûÊìä„ÄåÁôºÈÄÅÂØ´ÂÖ•„ÄçÊåâÈàï‰∏äÂÇ≥]";
            };
            reader.readAsDataURL(file);
        }

        // --- AUDIO RECORDING ---
        async function startAudioRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                addMessage("‚ö†Ô∏è ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÈåÑÈü≥ÂäüËÉΩ", 'system');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = uploadAudioRecording;
                
                mediaRecorder.start();
                document.getElementById('recording-status').classList.remove('hidden');
                document.getElementById('recording-status').classList.add('flex');
                addMessage("üéôÔ∏è ÈñãÂßãÈåÑÈü≥...", 'system');
            } catch (err) {
                console.error("Recording error:", err);
                addMessage("‚ö†Ô∏è ÁÑ°Ê≥ïÂïüÂãïÈåÑÈü≥ÔºåË´ãÊ™¢Êü•È∫•ÂÖãÈ¢®Ê¨äÈôê", 'system');
            }
        }

        function stopAudioRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('recording-status').classList.add('hidden');
                document.getElementById('recording-status').classList.remove('flex');
                addMessage("‚èπÔ∏è ÈåÑÈü≥ÁµêÊùüÔºåËôïÁêÜ‰∏≠...", 'system');
            }
        }

        async function uploadAudioRecording() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `${dateStr}-Audio.webm`;
            
            if (!appState.driveUrl) {
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                addMessage(`‚ö†Ô∏è Êú™Ë®≠ÂÆö Drive ‰∏äÂÇ≥ URLÔºåÂ∑≤Ëá™Âãï‰∏ãËºâÊ™îÊ°à: ${filename}`, 'system');
                return;
            }

            addMessage(`‚òÅÔ∏è Ê≠£Âú®‰∏äÂÇ≥ ${filename} Âà∞ Google Drive...`, 'system');
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async function() {
                const base64data = reader.result.split(',')[1];
                try {
                    const res = await fetch(appState.driveUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: filename,
                            mimeType: 'audio/webm',
                            data: base64data
                        })
                    });
                    addMessage(`‚úÖ ÈåÑÈü≥Â∑≤ÁôºÈÄÅËá≥Èõ≤Á´ØÁ°¨Á¢üÊéíÁ®ã (Ëã•Â§±ÊïóË´ãÊ™¢Êü• Apps Script Ë®≠ÂÆö)`, 'system');
                } catch (e) {
                    addMessage(`‚ùå ‰∏äÂÇ≥Â§±Êïó: ${e.message}`, 'system');
                }
            };
        }

        // --- WEB SCRAPER & SEARCH ---
        async function fetchUrlViaGas(url) {
            if (!appState.docMonitorUrl) return null;
            try {
                const res = await fetch(appState.docMonitorUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ type: 'scrape_and_log', url: url })
                });
                const text = await res.text();
                if (text && !text.startsWith("Error")) return text;
                return null;
            } catch (e) {
                console.error("GAS Scrape Error:", e);
                return null;
            }
        }
        
        async function searchViaSerpApi(query) {
            if (!appState.keys.serpapi) return null;
            addMessage(`üîç Ê≠£Âú®ÈÄèÈÅé SerpApi (Google) ÊêúÂ∞ãÔºö${query}...`, 'system');
            
            const targetUrl = `https://serpapi.com/search.json?q=${encodeURIComponent(query)}&api_key=${appState.keys.serpapi}&engine=google&gl=tw&hl=zh-tw`;
            
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`,
                `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`
            ];

            let serpData = null;
            let lastErrorMsg = "";

            for (const proxy of proxies) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout per proxy
                    const res = await fetch(proxy, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!res.ok) {
                        lastErrorMsg = `HTTP ${res.status}`;
                        continue;
                    }

                    const data = await res.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    serpData = data;
                    break;
                } catch (err) {
                    lastErrorMsg = err.name === 'AbortError' ? 'ÈÄ£Á∑öÈÄæÊôÇ' : err.message;
                    console.warn("Proxy attempt failed:", proxy, lastErrorMsg);
                    if (err.message && err.message.toLowerCase().includes("invalid api key")) {
                        throw new Error("SerpApi ÈáëÈë∞ÁÑ°ÊïàÊàñÂ∑≤ËÄóÁõ°");
                    }
                }
            }

            if (!serpData) {
                throw new Error(`SerpApi ‰ª£ÁêÜÈÄ£Á∑öÁöÜÂ§±Êïó (${lastErrorMsg})`);
            }
            
            let resultText = "„ÄêSerpApi ÊêúÂ∞ãÁµêÊûú„Äë\n";
            if (serpData.organic_results && serpData.organic_results.length > 0) {
                serpData.organic_results.slice(0, 5).forEach((item, index) => {
                    resultText += `${index + 1}. [${item.title}](${item.link})\n   ${item.snippet || ''}\n`;
                });
            } else {
                resultText += "Êú™ÊâæÂà∞Áõ∏ÈóúÁµêÊûú„ÄÇ";
            }
            
            return resultText;
        }
        
        async function searchViaGas(query) {
             if (!appState.docMonitorUrl) return null;
             try {
                addMessage(`üîç Ê≠£Âú®ÈÄèÈÅé Google News/Wiki ÊêúÂ∞ãÔºö${query}...`, 'system');
                const res = await fetch(appState.docMonitorUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ type: 'search', query: query })
                });
                const text = await res.text();
                if (text && !text.startsWith("Error")) return text;
                return "ÊêúÂ∞ãÂ§±ÊïóÊàñÁÑ°ÁµêÊûú";
            } catch (e) {
                console.error("GAS Search Error:", e);
                return "ÊêúÂ∞ãÈÄ£Á∑öÈåØË™§";
            }
        }

        async function extractContentFromUrl(url) {
            if (appState.docMonitorUrl) {
                const gasContent = await fetchUrlViaGas(url);
                if (gasContent) return gasContent;
            }
            try {
                if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('facebook.com') || url.includes('twitter.com') || url.includes('x.com')) return null;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                const data = await res.json();
                if (!data.contents) return null;
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                const scripts = doc.querySelectorAll('script, style, nav, footer, header, aside, iframe, noscript');
                scripts.forEach(node => node.remove());
                let text = doc.body.innerText || "";
                text = text.replace(/\s+/g, ' ').trim();
                return text.substring(0, 15000); 
            } catch (e) { return null; }
        }

        // --- PASTE HANDLER ---
        function handlePaste(e) {
            const items = (e.clipboardData || window.clipboardData).items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        appState.pastedImageBase64 = event.target.result;
                        const indicator = document.getElementById('paste-indicator');
                        if(indicator) indicator.classList.remove('hidden');
                        const docInput = document.getElementById('doc-input-main');
                        if(docInput) docInput.value = "[Â∑≤ÂÅµÊ∏¨Âà∞Ââ™Ë≤ºÁ∞øÂúñÁâáÔºåË´ãÈªûÊìä„ÄåÁôºÈÄÅÂØ´ÂÖ•„ÄçÊåâÈàï‰∏äÂÇ≥]";
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault(); 
                    return;
                }
            }
        }
        
        function handleNoteKeydown(e) {
            if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;
            
            if (appState.pastedImageBase64) {
                 const docInput = document.getElementById('doc-input-main');
                 if (docInput.value === "[Â∑≤ÂÅµÊ∏¨Âà∞Ââ™Ë≤ºÁ∞øÂúñÁâáÔºåË´ãÈªûÊìä„ÄåÁôºÈÄÅÂØ´ÂÖ•„ÄçÊåâÈàï‰∏äÂÇ≥]" || docInput.value === "[Â∑≤ÂÅµÊ∏¨Âà∞ÈÅ∏ÊìáÁöÑÂúñÁâáÔºåË´ãÈªûÊìä„ÄåÁôºÈÄÅÂØ´ÂÖ•„ÄçÊåâÈàï‰∏äÂÇ≥]") {
                     appState.pastedImageBase64 = null;
                     document.getElementById('paste-indicator').classList.add('hidden');
                     docInput.value = "";
                 }
            }
            if (e.ctrlKey && e.key === 'Enter') {
                handleDocWriteBtn();
            }
        }
        
        function clearNoteInput() {
             document.getElementById('doc-input-main').value = '';
             document.getElementById('doc-input-sub').value = '';
             appState.pastedImageBase64 = null;
             document.getElementById('paste-indicator').classList.add('hidden');
        }

        // --- DOC WRITER UI LOGIC ---
        function setWriteMode(mode) {
            appState.writeMode = mode;
            ['text', 'image', 'link'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if(m === mode) btn.className = 'text-xs px-3 py-1 rounded-full bg-blue-600 text-white font-bold transition-all';
                else btn.className = 'text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-bold hover:text-white transition-all';
            });
            const mainInput = document.getElementById('doc-input-main');
            const subInput = document.getElementById('doc-input-sub');
            
            if(mode === 'text') {
                mainInput.placeholder = "Ëº∏ÂÖ•ÊñáÂ≠óÂÖßÂÆπÔºåÊàñÁõ¥Êé• Ctrl+V Ë≤º‰∏äÂúñÁâá...";
                subInput.classList.add('hidden');
            } else if (mode === 'image') {
                mainInput.placeholder = "Ëº∏ÂÖ•ÂúñÁâáÁ∂≤ÂùÄ (https://...)";
                subInput.classList.add('hidden');
            } else if (mode === 'link') {
                mainInput.placeholder = "Ëº∏ÂÖ•ÈÄ£ÁµêÈ°ØÁ§∫ÊñáÂ≠ó";
                subInput.placeholder = "Ëº∏ÂÖ•ÈÄ£ÁµêÁ∂≤ÂùÄ (https://...)";
                subInput.classList.remove('hidden');
            }
        }

        async function handleDocWriteBtn() {
            const targetUrl = (appState.activeNotebook === 1) ? appState.noteDocUrl : appState.noteDocUrl2;
            
            if(!targetUrl) return alert(`Ë´ãÂÖàËá≥Ë®≠ÂÆöËº∏ÂÖ•„ÄåÈö®ÊâãË®ò‰∫ãÊú¨ ${appState.activeNotebook === 1 ? 'A' : 'B'}„ÄçÁöÑ Apps Script URL`);
            
            const mainVal = document.getElementById('doc-input-main').value.trim();
            const subVal = document.getElementById('doc-input-sub').value.trim();
            const sendBtn = document.getElementById('note-send-btn');
            
            let payload = {};
            
            let currentMode = appState.writeMode;
            if ((currentMode === 'image' || currentMode === 'link') && 
                !mainVal.match(/^https?:\/\//i) && mainVal.length > 0) {
                currentMode = 'text';
            }
            
            if (appState.pastedImageBase64 && (mainVal.includes("[Â∑≤ÂÅµÊ∏¨Âà∞"))) {
                payload = { type: 'image_base64', content: appState.pastedImageBase64 };
            } else {
                if(!mainVal && appState.writeMode !== 'image_base64') return; 
                
                if(currentMode === 'text') payload = { type: 'text', content: mainVal };
                else if (currentMode === 'image') payload = { type: 'image', content: mainVal };
                else if (currentMode === 'link') {
                    if(!subVal) return alert("Ë´ãËº∏ÂÖ•ÈÄ£ÁµêÁ∂≤ÂùÄ");
                    payload = { type: 'link', text: mainVal, content: subVal };
                }
            }
            
            if(sendBtn) {
                const originalText = sendBtn.innerHTML;
                sendBtn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> ‚è≥ ÂØ´ÂÖ•‰∏≠...';
                sendBtn.classList.add('opacity-70', 'cursor-not-allowed');
                
                try {
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(payload)
                    });
                    addMessage(`üìù Â∑≤ÂØ´ÂÖ•${appState.activeNotebook === 1 ? 'Á≠ÜË®òÊú¨ A' : 'Á≠ÜË®òÊú¨ B'}`, 'system');
                    clearNoteInput();
                } catch(e) { alert("ÂØ´ÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü• URL"); }
                finally {
                    sendBtn.innerHTML = originalText;
                    sendBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            }
        }

        // --- DOC VIEWER ---
        function openNoteDocViewer() { 
            const targetUrl = (appState.activeNotebook === 1) ? appState.noteDocUrl : appState.noteDocUrl2;
            if(!targetUrl) return alert(`Ë´ãÂÖàË®≠ÂÆöÈö®ÊâãË®ò‰∫ãÊú¨ ${appState.activeNotebook === 1 ? 'A' : 'B'} URL`);
            
            document.getElementById('doc-viewer-modal').classList.remove('hidden'); 
            refreshNoteDocView(); 
        }
        function closeDocViewer() { document.getElementById('doc-viewer-modal').classList.add('hidden'); }
        
        async function refreshNoteDocView() {
            const area = document.getElementById('doc-content-area');
            const targetUrl = (appState.activeNotebook === 1) ? appState.noteDocUrl : appState.noteDocUrl2;
            
            area.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 gap-2"><div class="dot-flashing bg-slate-400"></div> ËÆÄÂèñ‰∏≠...</div>';
            try {
                const res = await fetch(targetUrl);
                const text = await res.text();
                area.innerHTML = text || '<div class="text-center text-slate-400">Ë®ò‰∫ãÊú¨ÊòØÁ©∫ÁöÑ</div>';
            } catch(e) { area.innerHTML = '<div class="text-center text-red-500">ËÆÄÂèñÂ§±Êïó</div>'; }
        }

        // --- FIXED TEST CONNECTION ---
        function testDocConnection() {
            const url = document.getElementById('key-doc-url').value.trim();
            const statusEl = document.getElementById('doc-monitor-status');
            
            if(!url) return alert("Ë´ãËº∏ÂÖ•Á≥ªÁµ±‰ª£ÁêÜ Google Doc URL");
            
            statusEl.innerText = "Ê∏¨Ë©¶‰∏≠...";
            statusEl.className = "text-[10px] text-blue-400 font-bold animate-pulse";
            
            // ÂòóË©¶ËàáÂØ¶ÈöõÁà¨Ëü≤ÊôÇÂÆåÂÖ®Áõ∏ÂêåÁöÑ POST Ë´ãÊ±Ç
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ type: 'test_connection' })
            }).then(res => res.text()).then(text => {
                alert("Ê∏¨Ë©¶ÊàêÂäüÔºÅ‰º∫ÊúçÂô®Â∑≤ÂõûÊáâÈÄ£Á∑ö„ÄÇ");
                statusEl.innerText = "ÈÄ£Á∑öÊàêÂäü";
                statusEl.className = "text-[10px] text-green-400 font-bold";
            }).catch(e => {
                // Â¶ÇÊûúÈÅ≠ÈÅá CORS Ë¢´ÈòªÊìãÔºåÈôçÁ¥öÊ∏¨Ë©¶ no-cors Ê®°Âºè‰ª•Á¢∫ÂÆöÁ∂≤ÂùÄÂ≠òÂú®
                fetch(url, { mode: 'no-cors' }).then(() => {
                    alert("Ê∏¨Ë©¶Ë´ãÊ±ÇÂ∑≤ÈÄÅÂá∫ÔºÅ\n\nÂèóÈôêÊñºÁÄèË¶ΩÂô®ÂÆâÂÖ®ÊîøÁ≠ñÔºåÁÑ°Ê≥ïËÆÄÂèñÂõûÂÇ≥ÂÖßÂÆπÔºå‰ΩÜÁ∂≤Ë∑ØË´ãÊ±ÇÂ∑≤ÊàêÂäüÂÇ≥Âá∫Ëá≥Ë©≤ URL„ÄÇËã•ÊÇ®ÁöÑ Apps Script Ë®≠ÁΩÆÊ≠£Á¢∫ÔºåÂç≥‰ª£Ë°®ÈÄ£Á∑öÊàêÂäü„ÄÇ");
                    statusEl.innerText = "ÈÄ£Á∑öÊàêÂäü (ÁÑ°CORSÂõûÂÇ≥)";
                    statusEl.className = "text-[10px] text-yellow-400 font-bold";
                }).catch(err => {
                    alert("ÈÄ£Á∑öÂ§±ÊïóÔºö" + err.message);
                    statusEl.innerText = "Ê∏¨Ë©¶Â§±Êïó";
                    statusEl.className = "text-[10px] text-red-400 font-bold";
                });
            });
        }

        // --- AI LOGIC ---
        async function handleSendMessage() {
            if(appState.isThinking) return;
            const input = document.getElementById('user-input');
            let text = input.value.trim();
            if (text.length > 4 && text.length % 2 === 0) {
                 const mid = text.length / 2;
                 if (text.substring(0, mid) === text.substring(mid)) { text = text.substring(0, mid); }
            }
            if(!text) return;

            // 1. Voice Recording Commands
            if (text.includes("ÈñãÂßãÈåÑÈü≥")) {
                input.value = ''; initialInput = '';
                addMessage(text, 'user');
                startAudioRecording();
                return;
            }
            if (text.includes("ÂÅúÊ≠¢ÈåÑÈü≥")) {
                input.value = ''; initialInput = '';
                addMessage(text, 'user');
                stopAudioRecording();
                return;
            }

            // 2. Emergency Call Command (Call110 / Call119 / Êí•Êâì110)
            const emergencyMatch = text.match(/^(?:call|Êí•Êâì)\s*(110|119)$/i);
            if (emergencyMatch) {
                input.value = ''; initialInput = '';
                if (recognition && !appState.isContinuous) recognition.stop();
                triggerEmergency(emergencyMatch[1]);
                return;
            }

            // 3. Normal Call Command (ÊîØÊè¥ call ËôüÁ¢º / Êí•Êâì ËôüÁ¢º) + NATIVE BRIDGE
            const callMatch = text.match(/^(?:call|Êí•Êâì)\s*(\+?\d+)$/i);
            if (callMatch) {
                input.value = ''; initialInput = '';
                if (recognition && !appState.isContinuous) recognition.stop();
                const number = callMatch[1];
                
                // ÂÑ™ÂÖà‰ΩøÁî® Native Bridge Áõ¥Êé•Êí•Êâì
                if (executeNativeCall(number)) {
                    addMessage(`üìû Â∑≤ÈÄèÈÅéÂéüÁîü Bridge ÁÇ∫ÊÇ®Áõ¥Êé•Êí•Âá∫ËôüÁ¢ºÔºö${number}`, 'system');
                } else {
                    // Ëã•ÁÑ° BridgeÔºåÈôçÁ¥öÁÇ∫ÂÇ≥Áµ± tel: ÂëºÂè´
                    addMessage(`üìû Â∑≤ÁÇ∫ÊÇ®Â∞áËôüÁ¢ºÂ°´ÂÖ•ÈõªË©± APPÔºö${number}\n\n(Ë®ªÔºöÁõÆÂâçËôïÊñºÁ¥îÁ∂≤È†ÅÁí∞Â¢ÉÔºåÂü∫ÊñºÂÆâÂÖ®Ê©üÂà∂ÁÑ°Ê≥ïÁõ¥Êé•Êí•Êâì„ÄÇËã•ÊÇ®Â∑≤Â∞ÅË£ùÁÇ∫ APPÔºåË´ãÂØ¶‰Ωú Android/iOS Bridge ‰ª•ÂïüÁî®Ëá™ÂãïÊí•Ëôü)`, 'system');
                    window.open(`tel:${number}`, '_self');
                }
                return;
            }

            appState.isThinking = true;
            updateSendButtonState(true);
            addMessage(text, 'user');
            
            input.value = '';
            initialInput = ''; 
            if (recognition && !appState.isContinuous) {
                recognition.stop();
            }
            
            renderThinkingState(true);

            // 4. Reminder Follow-up Logic
            if (appState.pendingReminder && appState.reminderStage > 0) {
                const todo = appState.todos.find(t => t.id === appState.pendingReminder);
                if (todo) {
                    let combinedText = todo.tempTimeStr ? `${todo.tempTimeStr} ${text}` : text;
                    const timeInfo = parseTimeNatural(combinedText);
                    
                    if (timeInfo.complete) {
                        todo.time = new Date(timeInfo.timestamp).toLocaleString();
                        todo.alertTime = timeInfo.timestamp;
                        todo.alerted = false;
                        delete todo.tempTimeStr;
                        appState.pendingReminder = null;
                        appState.reminderStage = 0;
                        addMessage(`üëå Â∑≤Ë®≠ÂÆöÊèêÈÜíÔºö${todo.text} Êñº ${todo.time}`, 'system');
                    } else if (timeInfo.missing === 'date') {
                        todo.tempTimeStr = combinedText; 
                        addMessage(`Ë´ãÂïèÊòØ„Äå‰ªäÂ§©„Äç„ÄÅ„ÄåÊòéÂ§©„ÄçÈÇÑÊòØÂì™‰∏ÄÂ§©Ôºü`, 'system');
                        appState.reminderStage = 2; 
                    } else if (timeInfo.missing === 'ampm') {
                        todo.tempTimeStr = combinedText;
                        addMessage(`Ë´ãÂïèÊòØ„Äå‰∏äÂçà„ÄçÈÇÑÊòØ„Äå‰∏ãÂçà„ÄçÔºü`, 'system');
                        appState.reminderStage = 2;
                    } else {
                        addMessage(`ÁÑ°Ê≥ïË≠òÂà•ÊôÇÈñìÔºåË´ãÈáçË©¶ (‰æãÂ¶Ç: ÊòéÂ§©‰∏ãÂçà3Èªû)`, 'system');
                    }
                    saveData();
                    renderTodos();
                }
                
                appState.isThinking = false;
                updateSendButtonState(false);
                renderThinkingState(false);
                return;
            }

            // 5. Reminder Trigger
            const reminderMatch = text.match(/^(?:ÊèêÈÜí|reminder)(.*)$/i);
            if (reminderMatch) {
                const content = reminderMatch[1].trim() || "Êú™ÂëΩÂêç‰∫ãÈ†Ö";
                const newTodo = { id: Date.now(), text: content, done: false, time: 'Ë©¢Âïè‰∏≠...', alerted: false };
                appState.todos.push(newTodo);
                appState.pendingReminder = newTodo.id;
                appState.reminderStage = 1; 
                saveData();
                renderTodos();
                
                addMessage(`üìù Â∑≤Â∞á„Äå${content}„ÄçÂä†ÂÖ•Ë°åÁ®ãÔºåË´ãÂïè‰ªÄÈ∫ºÊôÇÂÄôÊèêÈÜíÔºü`, 'system');
                
                appState.isThinking = false;
                updateSendButtonState(false);
                renderThinkingState(false);
                return;
            }

            try {
                let systemPromptAddon = "";
                let injectedContext = "";
                let modelToUse = appState.currentModel;
                let enableSearchTool = false;
                
                if (appState.isSearchEnabled) enableSearchTool = true;

                // 6. Search Pipeline Logic
                const searchMatch = text.match(/^(?:ÊêúÂ∞ã|search)(.*)$/i);
                
                if (searchMatch) {
                    const searchKeyword = searchMatch[1].trim() || "‰ªäÊó•Êñ∞ËÅû";
                    let searchResultText = "";
                    let usedSerp = false;

                    if (appState.keys.serpapi) {
                        try {
                            searchResultText = await searchViaSerpApi(searchKeyword);
                            usedSerp = true;
                        } catch (serpErr) {
                            addMessage(`‚ö†Ô∏è ${serpErr.message}ÔºåÊ≠£Âú®ÈÄÄÂõû‰ΩøÁî®ÂÇôÁî®ÊêúÂ∞ã„ÄÇ`, 'system');
                        }
                    }
                    
                    if (!usedSerp && appState.docMonitorUrl) {
                        searchResultText = await searchViaGas(searchKeyword);
                    } else if (!usedSerp) {
                        if (appState.keys.gemini) {
                             modelToUse = 'gemini';
                             enableSearchTool = true;
                             systemPromptAddon += `(Á≥ªÁµ±Êåá‰ª§: ‰ΩøÁî®ËÄÖÊ≠£Âú®Ë¶ÅÊ±ÇÊêúÂ∞ã„ÄÇË´ãÂãôÂøÖ‰ΩøÁî® Google Search Â∑•ÂÖ∑Êü•Êâæ„Äå${searchKeyword}„ÄçÁöÑÊúÄÊñ∞Ë≥áË®äÔºå‰∏¶Ë©≥Á¥∞ÂõûÁ≠î„ÄÇËã•ÊÇ®ÁÑ°Ê≥ï‰ΩøÁî®Â∑•ÂÖ∑ÔºåË´ãË™†ÂØ¶ÂëäÁü•„ÄÇ)`;
                        } else {
                             throw new Error("ÁÑ°Ê≥ïÈÄ≤Ë°åÊêúÂ∞ãÔºöÊú™Ë®≠ÂÆö SerpApi Êàñ Google Doc ‰ª£ÁêÜ URLÔºå‰∏îÁÑ° Gemini ÈáëÈë∞ÂÇôÊè¥„ÄÇ");
                        }
                    }

                    if (searchResultText) {
                        addMessage(searchResultText, 'system');
                        let summaryModel = appState.currentModel;
                        if (summaryModel !== 'cohere' && summaryModel !== 'groq') {
                            if (appState.keys.cohere) summaryModel = 'cohere';
                            else if (appState.keys.groq) summaryModel = 'groq';
                        }
                        modelToUse = summaryModel;
                        text = `Ë´ãÊ†πÊìö‰ª•‰∏ãÊêúÂ∞ãÁµêÊûúÔºåÁî®ÁπÅÈ´î‰∏≠ÊñáÁÇ∫ÊàëÂÅö‰∏Ä‰ªΩÈáçÈªûÊëòË¶ÅÔºö\n\n${searchResultText}`;
                        injectedContext = ""; systemPromptAddon = ""; enableSearchTool = false;
                    }
                } else {
                    const urlMatch = text.match(/https?:\/\/[^\s]+/);
                    if (urlMatch) {
                        const url = urlMatch[0];
                        if (!url.includes('youtube.com') && !url.includes('youtu.be') && !url.includes('twitter.com') && !url.includes('facebook.com')) {
                            addMessage(`üîç Ê≠£Âú®ÈÄèÈÅé Google Doc ‰ª£ÁêÜÊäìÂèñÁ∂≤È†Å...`, 'system');
                            const content = await fetchUrlViaGas(url);
                            if (content) {
                                injectedContext = `\n\n[Á≥ªÁµ±: Â∑≤ÈÄèÈÅé Google Doc ÊàêÂäüÊäìÂèñÁ∂≤È†ÅÂÖßÂÆπ (${url})ÔºåË´ãÊ†πÊìö‰ª•‰∏ãÂÖßÂÆπÂõûÁ≠î]:\n${content}\n\n`;
                                enableSearchTool = false; 
                            } else {
                                systemPromptAddon += `(Á≥ªÁµ±: ÂòóË©¶ÊäìÂèñÁ∂≤È†ÅÂ§±ÊïóÔºåË´ãÂòóË©¶‰ΩøÁî®ÊÇ®ÁöÑ Search Â∑•ÂÖ∑ÊêúÂ∞ãË©≤Á∂≤ÂùÄÂÖßÂÆπ)`;
                                if (appState.keys.gemini) { modelToUse = 'gemini'; enableSearchTool = true; }
                            }
                        } else if (url.includes('youtube') || url.includes('youtu.be')) {
                             if (appState.keys.gemini) {
                                modelToUse = 'gemini';
                                enableSearchTool = true; 
                                systemPromptAddon += `(Á≥ªÁµ±: ÈÄôÊòØ‰∏ÄÂÄã YouTube ÈÄ£Áµê„ÄÇË´ã‰ΩøÁî® Search Â∑•ÂÖ∑ÊêúÂ∞ãË©≤ÂΩ±ÁâáÁöÑÊ®ôÈ°å„ÄÅÊëòË¶ÅÊàñË©ïË´ñÂÖßÂÆπ‰æÜÂõûÁ≠î„ÄÇ)`;
                             }
                        }
                    }
                }

                // 7. API Fallback Sequence Execution
                let finalRes;
                let successfulModel = modelToUse;
                const promptToSent = `${text}\n${systemPromptAddon}\n${injectedContext}`;

                try {
                    finalRes = await fetchAIResponse(promptToSent, successfulModel, { enableSearch: enableSearchTool, disableSearch: !enableSearchTool && injectedContext !== "" });
                } catch (err1) {
                    console.warn(err1);
                    addMessage(`‚ö†Ô∏è ${MODEL_CONFIG[successfulModel]?.name || successfulModel} ÁôºÁîüÈåØË™§ (${err1.message})ÔºåÂòóË©¶ÂàáÊèõËá≥ Gemini...`, 'system');
                    successfulModel = 'gemini';
                    try {
                        finalRes = await fetchAIResponse(promptToSent, successfulModel, { enableSearch: enableSearchTool, disableSearch: !enableSearchTool && injectedContext !== "" });
                    } catch (err2) {
                        console.warn(err2);
                        addMessage(`‚ö†Ô∏è Gemini ÁôºÁîüÈåØË™§ (${err2.message})ÔºåÂòóË©¶ÂàáÊèõËá≥ Grok...`, 'system');
                        successfulModel = 'grok';
                        finalRes = await fetchAIResponse(promptToSent, successfulModel, { enableSearch: enableSearchTool, disableSearch: !enableSearchTool && injectedContext !== "" });
                    }
                }
                
                if(typeof finalRes === 'string') addMessage(finalRes, 'ai', successfulModel);
                else addMessage(finalRes.text, 'ai', successfulModel, finalRes.sources);

            } catch (error) {
                console.error("Handler Error:", error);
                addMessage(`[Á≥ªÁµ±ÈåØË™§] ${error.message || 'Êú™Áü•ÈåØË™§'}`, 'system');
            } finally {
                appState.isThinking = false;
                updateSendButtonState(false);
                renderThinkingState(false);
            }
        }

        // --- Natural Language Time Parser ---
        function parseTimeNatural(str) {
            const now = new Date();
            let result = { complete: false, timestamp: null, missing: null };
            
            const relMatch = str.match(/(\d+)\s*(ÂàÜÈêò|min|minute|Â∞èÊôÇ|hour|hr|Áßí|sec|second)Âæå?/i);
            if (relMatch) {
                const amount = parseInt(relMatch[1]);
                const unit = relMatch[2];
                if (unit.includes('ÂàÜ') || unit.includes('min')) now.setMinutes(now.getMinutes() + amount);
                else if (unit.includes('Â∞è') || unit.includes('h')) now.setHours(now.getHours() + amount);
                else if (unit.includes('Áßí') || unit.includes('s')) now.setSeconds(now.getSeconds() + amount);
                return { complete: true, timestamp: now.getTime() };
            }

            let targetDate = new Date();
            let hasDate = false;
            if (str.includes('ÊòéÂ§©') || str.includes('tomorrow')) {
                targetDate.setDate(targetDate.getDate() + 1);
                hasDate = true;
            } else if (str.includes('ÂæåÂ§©')) {
                targetDate.setDate(targetDate.getDate() + 2);
                hasDate = true;
            } else if (str.match(/\d{1,2}Êúà\d{1,2}Êó•/)) {
                const dMatch = str.match(/(\d{1,2})Êúà(\d{1,2})Êó•/);
                targetDate.setMonth(parseInt(dMatch[1]) - 1);
                targetDate.setDate(parseInt(dMatch[2]));
                hasDate = true;
            } else if (str.includes('‰ªäÂ§©') || str.includes('today')) {
                hasDate = true;
            }

            let hour = -1, minute = 0;
            const timeMatch = str.match(/(\d{1,2})[:Ôºö](\d{2})/); 
            const hourMatch = str.match(/(\d{1,2})Èªû(\d{1,2})?ÂàÜ?/); 
            
            if (timeMatch) {
                hour = parseInt(timeMatch[1]);
                minute = parseInt(timeMatch[2]);
            } else if (hourMatch) {
                hour = parseInt(hourMatch[1]);
                if (hourMatch[2]) minute = parseInt(hourMatch[2]);
            }

            let isPM = str.includes('‰∏ãÂçà') || str.includes('Êôö‰∏ä') || str.includes('pm') || str.includes('PM');
            let isAM = str.includes('‰∏äÂçà') || str.includes('Êó©‰∏ä') || str.includes('am') || str.includes('AM');

            if (hour !== -1) {
                if (hour < 12 && !isPM && !isAM && !str.includes('24h')) {
                    return { complete: false, missing: 'ampm' }; 
                }
                
                if (isPM && hour < 12) hour += 12;
                if (isAM && hour === 12) hour = 0; 

                targetDate.setHours(hour, minute, 0, 0);
                
                if (!hasDate) {
                    if (targetDate < new Date()) {
                        return { complete: false, missing: 'date' };
                    }
                }
                
                return { complete: true, timestamp: targetDate.getTime() };
            }

            return { complete: false, missing: 'time' };
        }

        async function fetchAIResponse(userText, model, options = {}) {
            const fetchWithTimeout = async (url, options, timeout = 30000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try { const response = await fetch(url, { ...options, signal: controller.signal }); clearTimeout(id); return response; } 
                catch (error) { clearTimeout(id); throw new Error(error.name === 'AbortError' ? 'ÈÄ£Á∑öÈÄæÊôÇ (30s)' : error.message); }
            };

            try {
                const key = appState.keys[model];
                if(!key) throw new Error(`Êú™Â°´ÂØ´ ${MODEL_CONFIG[model]?.name || model} API Key`);

                if(model === 'gemini') {
                    const modelName = 'gemini-2.5-flash';
                    const payload = { 
                        contents: [{ parts: [{ text: userText }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
                    };

                    if ((appState.isSearchEnabled || options.enableSearch) && !options.disableSearch) {
                        payload.tools = [{ google_search: {} }];
                    }

                    const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    const data = await res.json();
                    if (!res.ok) throw new Error(`Gemini ÈåØË™§: ${data.error?.message || res.status}`);

                    const candidate = data.candidates?.[0];
                    if (!candidate) return "‚ö†Ô∏è API Êú™ÂõûÂÇ≥ÂÖßÂÆπÔºåË´ãÊ™¢Êü•Ë®≠ÂÆö„ÄÇ";

                    let outputText = "";
                    if (candidate.content && candidate.content.parts) {
                        outputText = candidate.content.parts.filter(p => p.text).map(p => p.text).join("");
                    }

                    let sources = [];
                    if (candidate.groundingMetadata?.groundingAttributions) {
                        candidate.groundingMetadata.groundingAttributions.forEach(attr => {
                            if (attr.web?.uri) sources.push({ title: attr.web.title || "ÂèÉËÄÉÈÄ£Áµê", uri: attr.web.uri });
                        });
                    }

                    if (!outputText && sources.length > 0) outputText = "Â∑≤ÁÇ∫ÊÇ®ÊêúÂ∞ãÂà∞Áõ∏ÈóúË≥áË®äÔºåË´ãÂèÉËÄÉ‰æÜÊ∫êÈÄ£Áµê„ÄÇ";
                    else if (!outputText) outputText = "(ÁÑ°ÂõûÂÇ≥ÊñáÂ≠óÂÖßÂÆπ)";

                    return { text: outputText, sources: sources };
                    
                } else if (model === 'groq') {
                    const res = await fetchWithTimeout('https://api.groq.com/openai/v1/chat/completions', { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{ role: 'user', content: userText }] }) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error?.message || `Groq ÈåØË™§ (${res.status})`);
                    return data.choices?.[0]?.message?.content || "ÁÑ°ÂõûÊáâ";
                } else if (model === 'cohere') {
                    const res = await fetchWithTimeout('https://api.cohere.com/v1/chat', { 
                        method: 'POST', 
                        headers: { 
                            'Authorization': `Bearer ${key}`, 
                            'Content-Type': 'application/json', 
                            'Accept': 'application/json' 
                        }, 
                        body: JSON.stringify({ model: 'command-r-plus-08-2024', message: userText }) 
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(`Cohere ÈåØË™§: ${data.message || res.status}`);
                    return data.text || "ÁÑ°ÂõûÊáâ";
                } else if (model === 'grok') {
                    const ep = 'https://api.x.ai/v1/chat/completions';
                    const mName = 'grok-4-1-fast-reasoning';
                    const res = await fetchWithTimeout(ep, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:mName, messages:[{role:"user", content:userText}]}) });
                    const data = await res.json(); 
                    if (!res.ok) throw new Error(`${data.error?.message || res.status}`);
                    return data.choices?.[0]?.message?.content || "ÁÑ°ÂõûÊáâ";
                } else if (model === 'gpt') {
                    const ep = 'https://api.openai.com/v1/chat/completions';
                    const mName = 'gpt-4o-mini';
                    const res = await fetchWithTimeout(ep, { method:'POST', headers:{'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({model:mName, messages:[{role:"user", content:userText}]}) });
                    const data = await res.json(); 
                    if (!res.ok) throw new Error(`${data.error?.message || res.status}`);
                    return data.choices?.[0]?.message?.content || "ÁÑ°ÂõûÊáâ";
                }
            } catch(e) { throw e; }
        }

        // --- ALARM LOGIC ---
        function checkReminders() {
            const now = Date.now();
            appState.todos.forEach(todo => {
                if (todo.alertTime && !todo.alerted && !todo.done) {
                    if (now >= todo.alertTime) {
                        todo.alerted = true;
                        saveData();
                        triggerAlarm(todo.text);
                    }
                }
            });
        }

        function triggerAlarm(text) {
            document.getElementById('alarm-text').innerText = text;
            document.getElementById('alarm-modal').classList.remove('hidden');
            document.getElementById('alarm-modal').classList.add('flex');
            
            if (!alarmAudioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) alarmAudioCtx = new AudioContext();
            }
            
            if (alarmAudioCtx) {
                if (alarmAudioCtx.state === 'suspended') alarmAudioCtx.resume();
                
                const playBeep = () => {
                    const osc = alarmAudioCtx.createOscillator();
                    const gain = alarmAudioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, alarmAudioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(440, alarmAudioCtx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, alarmAudioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, alarmAudioCtx.currentTime + 0.5);
                    osc.connect(gain);
                    gain.connect(alarmAudioCtx.destination);
                    osc.start();
                    osc.stop(alarmAudioCtx.currentTime + 0.5);
                };
                
                playBeep();
                alarmInterval = setInterval(playBeep, 1000);
            }
            
            if (navigator.vibrate) {
                navigator.vibrate([300, 200, 300, 200, 300]);
            }
        }

        function stopAlarm() {
            document.getElementById('alarm-modal').classList.add('hidden');
            document.getElementById('alarm-modal').classList.remove('flex');
            if (alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
            if (navigator.vibrate) navigator.vibrate(0);
        }

        // --- INIT ---
        window.onload = () => {
            if(appState.messages.length === 0) {
                appState.messages.push({ id: 1, text: 'NOVA 16 ÂïüÂãïÔºÅ\n‚úÖ Êñ∞Â¢ûÊîØÊè¥Êåá‰ª§Ôºö„ÄåÊí•Êâì 09xx„ÄçÊàñ„Äåcall 09xx„Äç\n‚úÖ Âä†ÂÖ• Native Bridge Ëá™ÂãïÈôçÁ¥öÊ©üÂà∂ (ÊîØÊè¥ÂéüÁîü APP ÁÑ°Á∏´Êí•Ëôü)', sender: 'ai', model: 'gemini', time: getTime() });
            }
            renderAll();
            
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
            
            safeSet('key-gemini', appState.keys.gemini);
            safeSet('key-groq', appState.keys.groq);
            safeSet('key-cohere', appState.keys.cohere);
            safeSet('key-openai', appState.keys.openai);
            safeSet('key-grok', appState.keys.grok);
            safeSet('key-serpapi', appState.keys.serpapi);
            safeSet('key-doc-url', appState.docMonitorUrl);
            safeSet('key-note-doc-url', appState.noteDocUrl);
            safeSet('key-note-doc-url-2', appState.noteDocUrl2);
            safeSet('key-drive-url', appState.driveUrl);
            
            const inputMain = document.getElementById('doc-input-main');
            if(inputMain) inputMain.addEventListener('paste', handlePaste);
            
            setInterval(checkReminders, 10000);

            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) { 
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition; 
                
                recognition = new SR(); 
                recognition.lang = 'zh-TW'; 
                recognition.continuous = true; 
                recognition.interimResults = true; 
                
                let voiceTimer = null;
                let finalTranscript = ''; 
                
                recognition.onstart = () => {
                    appState.isListening = true;
                    updateVoiceUI();
                    const input = document.getElementById('user-input');
                    initialInput = input.value; 
                    finalTranscript = ''; 
                    if(input.value === '') input.placeholder = "ËÅÜËÅΩ‰∏≠... (6ÁßíÂæåËá™ÂãïÁôºÈÄÅ)";
                };
                
                recognition.onend = () => {
                    appState.isListening = false;
                    updateVoiceUI();
                    document.getElementById('user-input').placeholder = "Â∞çË©±„ÄÅËº∏ÂÖ•„ÄåÊêúÂ∞ã(ÂÖßÂÆπ)„ÄçÊàñ„ÄåÊí•Êâì(ËôüÁ¢º)„Äç...";
                    
                    if(voiceTimer) {
                        clearTimeout(voiceTimer);
                        voiceTimer = null;
                        const input = document.getElementById('user-input');
                        if(input.value.trim() !== initialInput.trim()) {
                             handleSendMessage();
                        }
                    }

                    if (appState.isContinuous) {
                        recognition.start();
                    }
                };
                
                recognition.onresult = (e) => {
                    let transcript = "";
                    for (let i = 0; i < e.results.length; ++i) {
                        transcript += e.results[i][0].transcript;
                    }

                    if (transcript.length > 0) {
                         const len = transcript.length;
                         if (len % 2 === 0) {
                             if (transcript.substring(0, len/2) === transcript.substring(len/2)) {
                                 transcript = transcript.substring(0, len/2);
                             }
                         }
                         const split = transcript.split(' ');
                         if (split.length >= 2) {
                             const half = split.length / 2;
                             if (Number.isInteger(half)) {
                                 const firstHalf = split.slice(0, half).join(' ');
                                 const secondHalf = split.slice(half).join(' ');
                                 if (firstHalf === secondHalf) {
                                     transcript = firstHalf;
                                 }
                             }
                         }
                    }
                    
                    const input = document.getElementById('user-input');
                    input.value = initialInput + (initialInput && transcript ? " " : "") + transcript;
                    
                    if (voiceTimer) clearTimeout(voiceTimer);
                    voiceTimer = setTimeout(() => {
                        handleSendMessage(); 
                        voiceTimer = null;   
                        recognition.stop(); 
                    }, 6000);
                };
                
                noteRecognition = new SR();
                noteRecognition.lang = 'zh-TW';
                noteRecognition.continuous = true; 
                noteRecognition.interimResults = true;
                
                let noteVoiceTimer = null;
                let noteFinalTranscript = '';

                noteRecognition.onstart = () => { 
                    appState.isNoteListening = true; 
                    updateNoteVoiceUI(); 
                    const el = document.getElementById('doc-input-main');
                    initialInput = el.value;
                    noteFinalTranscript = '';
                    if (el.value === "[Â∑≤ÂÅµÊ∏¨Âà∞Ââ™Ë≤ºÁ∞øÂúñÁâáÔºåË´ãÈªûÊìä„ÄåÁôºÈÄÅÂØ´ÂÖ•„ÄçÊåâÈàï‰∏äÂÇ≥]") {
                         appState.pastedImageBase64 = null;
                         document.getElementById('paste-indicator').classList.add('hidden');
                         el.value = "";
                         initialInput = "";
                    }
                };
                
                noteRecognition.onend = () => { 
                    appState.isNoteListening = false; 
                    updateNoteVoiceUI(); 
                    if(noteVoiceTimer) clearTimeout(noteVoiceTimer);
                };
                
                noteRecognition.onresult = (e) => {
                    let transcript = "";
                    for (let i = 0; i < e.results.length; ++i) {
                        transcript += e.results[i][0].transcript;
                    }

                    if (transcript.length > 0 && transcript.length % 2 === 0) {
                        const mid = transcript.length / 2;
                        if (transcript.substring(0, mid) === transcript.substring(mid)) {
                            transcript = transcript.substring(0, mid);
                        }
                    }
                    
                    const el = document.getElementById('doc-input-main');
                    const separator = (initialInput && transcript) ? "\n" : "";
                    el.value = initialInput + separator + transcript;
                    
                    if (noteVoiceTimer) clearTimeout(noteVoiceTimer);
                    noteVoiceTimer = setTimeout(() => {
                        noteRecognition.stop();
                    }, 6000);
                };
            }

            tryGetLocation(true);
            updateModelUI();
        };
    </script>
</body>
                </html>
